/* PhotoClip v2.0.0 | Relying on the plug-in [jquery.js] [iscroll-zoom.js] [hammer.js] [lrz.all.bundle.js] */
!function(t,o){"use strict";"function"==typeof define&&define.amd?define(["jquery","iscroll-zoom","hammer","lrz"],o):"object"==typeof exports?module.exports=o(require("jquery"),require("iscroll-zoom"),require("hammer"),require("lrz")):(t.bjj=t.bjj||{},t.bjj.PhotoClip=o(t.jQuery,t.IScroll,t.Hammer,t.lrz))}(this,function(t,o,e,n){"use strict";function i(o,e){if(!window.FileReader)return void alert("您的浏览器不支持 HTML5 的 FileReader API， 因此无法初始化图片裁剪插件，请更换最新的浏览器！");var n=t.extend({},s,e);a.call(this,o,n)}function a(i,a){function s(){co=!0,fo.append(this),w(ao,function(){ro=this.naturalWidth,so=this.naturalHeight},this),w(po,function(){u()}),Y.call(E,this)}function l(){var t={zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"};zo=new o(uo[0],t)}function u(){So=0,Co=0,Lo=0,fo.css({width:ro,height:so}),F(fo,So,Co,Lo),T(ro,so),zo.zoom(zo.options.zoomStart),p(ro,so);var t=.5*(_-ro*zo.options.zoomStart),o=.5*(to-so*zo.options.zoomStart);zo.scrollTo(t,o)}function p(t,o){po.css({width:t,height:o}),uo.append(po),zo.refresh()}function f(){var t=!!navigator.userAgent.match(/mobile/i);if(t){wo=new e(po[0]),wo.add(new e.Rotate);var o,n;wo.on("rotatemove",function(t){Fo||(o=t.rotation,o>180?o-=360:-180>o&&(o+=360),n=o>0?1:0>o?-1:0)}),wo.on("rotateend",function(t){Fo||Math.abs(o)>30&&(1==n?d(t.center):-1==n&&h(t.center))})}else po.on("dblclick",function(t){d({x:t.clientX,y:t.clientY})})}function d(t){m(90,t)}function h(t){m(-90,t)}function m(t,o){if(!Fo){Fo=!0;var e;e=o?x(po,o.x,o.y):y(po,uo,.5*_,.5*to);var n,i,a=z(Lo,e),r=a.x,s=a.y,c=0,l=0,u=0,f=0,d=Lo+t;90==d||-270==d?(c=r+s,l=s-r,d>Lo?(u=so-r-s,f=r-s):Lo>d&&(u=so-s-(ro-r),f=r+s-so),n=so,i=ro):180==d||-180==d?(c=2*r,l=2*s,d>Lo?(u=ro-r-(so-s),f=so-(r+s)):Lo>d&&(u=ro-(r+s),f=so-s-(ro-r)),n=ro,i=so):270==d||-90==d?(c=r-s,l=r+s,d>Lo?(u=r+s-ro,f=ro-r-(so-s)):Lo>d&&(u=s-r,f=ro-r-s),n=so,i=ro):(0==d||360==d||-360==d)&&(c=0,l=0,d>Lo?(u=r-s,f=r+s-ro):Lo>d&&(u=r+s-so,f=s-r),n=ro,i=so),0==Lo?(So=0,Co=0):90==Lo||-270==Lo?(So-=r+s,Co-=s-r):180==Lo||-180==Lo?(So-=2*r,Co-=2*s):(270==Lo||-90==Lo)&&(So-=r-s,Co-=r+s),So=So.toFixed(2)-0,Co=Co.toFixed(2)-0,F(fo,So,Co,Lo,r,s),S(fo,So,Co,d,200,function(){Fo=!1,Lo=d%360,So+=c+u,Co+=l+f,So=So.toFixed(2)-0,Co=Co.toFixed(2)-0,F(fo,So,Co,Lo),zo.scrollTo(zo.x-u*zo.scale,zo.y-f*zo.scale),T(n,i),zo.scale<zo.options.zoomMin&&zo.zoom(zo.options.zoomMin),p(n,i)})}}function g(){xo=document.createElement("canvas")}function v(){if(!co)return void alert("亲，当前没有图片可以裁剪!");var t=y(po,uo),o=zo.scale,e=xo.getContext("2d");e.clearRect(0,0,xo.width,xo.height),e.save(),oo&&eo?(xo.width=oo,xo.height=eo,e.scale(oo/_*o,eo/to*o)):(xo.width=_/o,xo.height=to/o),e.translate(So-t.x/o,Co-t.y/o),e.rotate(Lo*Math.PI/180),e.drawImage(ao[0],0,0),e.restore();try{var n=xo.toDataURL(H,1)}catch(i){throw new Error("截图失败！当前图片源文件可能存在跨域问题，请确保图片与应用同源。如果您是在本地环境下执行本程序，请更换至服务器环境。")}ho.css("background-image","url("+n+")"),B.call(E,n)}function b(){q()}function y(t,o,e,n){e=e||0,n=n||0;var i,a;return w(t,function(){i=t.offset()}),w(o,function(){a=o.offset()}),{x:a.left-i.left+e,y:a.top-i.top+n}}function x(t,o,e){o=o||0,e=e||0;var n;return w(t,function(){n=t.offset()}),{x:o+Mo.scrollLeft()-n.left,y:e+Mo.scrollTop()-n.top}}function w(o,e,n){var i=t();t.each(o,function(o,e){for(var n,a=e instanceof jQuery?e:t(e),r=a.parents().addBack().filter(":hidden"),o=r.length;o--&&a.is(":hidden");)n=r.eq(o),"none"===n.css("display")&&(i=i.add(n.show()))}),"function"==typeof e&&e.call(n||this),i.hide()}function z(t,o){var e=zo.scale,n={};return 0==t?(n.x=o.x/e,n.y=o.y/e):90==t||-270==t?(n.x=o.y/e,n.y=so-o.x/e):180==t||-180==t?(n.x=ro-o.x/e,n.y=so-o.y/e):(270==t||-90==t)&&(n.x=ro-o.y/e,n.y=o.x/e),n}function k(t,o,e,n){var i=t/e,a=o/n;return i>a?i:a}function T(t,o){zo.options.zoomMin=k(_,to,t,o),zo.options.zoomMax=Math.max(1,zo.options.zoomMin),zo.options.zoomStart=Math.min(zo.options.zoomMax,k(ko,To,t,o))}function j(){ao&&ao.length&&(ao.off(),ao.remove(),delete ao[0])}function M(o){j(),ao=t("<img>").css({"user-select":"none","pointer-events":"none"}),no||(no=!0,X.call(E,ao[0])),ao.on("load",s),ao.attr("src",o)}function F(t,o,e,n,i,a){i=i||0,a=a||0;var r={};r[c+"transform"]="translateZ(0) translate("+o+"px,"+e+"px) rotate("+n+"deg)",r[c+"transform-origin"]=i+"px "+a+"px",t.css(r)}function S(t,o,e,n,i,a){t.css(c+"transform"),t.css(c+"transition",c+"transform "+i+"ms"),t.one(r,function(){t.css(c+"transition",""),a.call(this)}),t.css(c+"transform","translateZ(0) translate("+o+"px,"+e+"px) rotate("+n+"deg)")}function C(t){var o=t+"";return/%$/.test(o)}function L(){lo=t(i).css({"user-select":"none",overflow:"hidden"}),"static"==lo.css("position")&&lo.css("position","relative"),uo=t("<div class='photo-clip-view'>").css({position:"absolute",left:"50%",top:"50%"}).appendTo(lo),po=t("<div class='photo-clip-moveLayer'>").appendTo(uo),fo=t("<div class='photo-clip-rotateLayer'>").appendTo(po);var o=t("<div class='photo-clip-mask'>").css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo(lo);mo=t("<div class='photo-clip-mask-left'>").css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto","background-color":"rgba(0,0,0,.5)"}).appendTo(o),go=t("<div class='photo-clip-mask-right'>").css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","background-color":"rgba(0,0,0,.5)"}).appendTo(o),vo=t("<div class='photo-clip-mask-top'>").css({position:"absolute",left:0,right:0,top:0,bottom:"50%","background-color":"rgba(0,0,0,.5)"}).appendTo(o),bo=t("<div class='photo-clip-mask-bottom'>").css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),yo=t("<div class='photo-clip-area'>").css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%"}).appendTo(o),ho=t(Q),ho.length&&ho.css({"background-color":"#666","background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}function q(t,o){"number"==typeof t&&(N=t),"number"==typeof o&&(V=o),_=N,to=V,(G||J)&&(K=N/V),w(lo,function(){ko=lo.width(),To=lo.height(),G&&(_=ko/100*parseFloat(G),J||(to=_/K)),J&&(to=To/100*parseFloat(J),G||(_=to*K)),uo.css({width:_,height:to,"margin-left":-_/2,"margin-top":-to/2}),mo.css({"margin-right":_/2,"margin-top":-to/2,"margin-bottom":-to/2}),go.css({"margin-left":_/2,"margin-top":-to/2,"margin-bottom":-to/2}),vo.css({"margin-bottom":to/2}),bo.css({"margin-top":to/2}),yo.css({width:_,height:to,"margin-left":-_/2-1,"margin-top":-to/2-1})})}function A(t){M(t)}function R(){io.off("change"),io=null,wo?(wo.off("rotatemove"),wo.off("rotateend"),wo.destroy(),wo=null):po.off("dblclick"),zo.destroy(),zo=null,lo.empty(),lo=null,uo=null,po=null,fo=null,ho.css({"background-color":"","background-repeat":"","background-position":"","background-size":""}),ho=null}var E=this,I=a.size,W=a.adaptive,P=a.outputSize,H=a.outputType||"image/jpeg",O=a.file,D=a.source,Q=a.view,U=a.ok,X=a.loadStart,Y=a.loadComplete,Z=a.loadError,B=a.clipFinish,$=a.lrzOption;t.isArray(I)||(I=[260,260]),t.isArray(P)||(P=[0,0]);var G,J,K,N=I[0]||260,V=I[1]||260,_=N,to=V,oo=Math.max(P[0],0),eo=Math.max(P[1],0);t.isArray(W)&&(W[0]&&(G=C(W[0])?W[0]:!1),W[1]&&(J=C(W[1])?W[1]:!1)),"jpg"===H?H="image/jpeg":"png"===H&&(H="image/png");var no=!1,io=t(O);io.length&&(io.attr("accept","image/jpeg, image/x-png, image/gif"),io.on("change",function(){if(this.files.length){var t=this.files[0];if(!/image\/\w+/.test(t.type))return alert("图片格式不正确，请选择正确格式的图片文件！"),!1;no||(no=!0,X.call(E,t));var o=new FileReader;o.onprogress=function(t){console.log((t.loaded/t.total*100).toFixed()+"%")},o.onload=function(){n(t,$).then(function(t){M(t.base64),no=!1}).catch(function(t){alert("图片处理失败"),Z.call(E,t),no=!1})},o.onerror=function(t){alert("图片加载失败"),Z.call(E,t),no=!1},o.readAsDataURL(t)}}),io.click(function(){this.value=""})),D&&A(D);var ao,ro,so,co,lo,uo,po,fo,ho,mo,go,vo,bo,yo,xo,wo,zo,ko,To;L(),l(),f(),g();var jo=t(U);jo.length&&jo.click(function(){v()});var Mo=t(window);b(),Mo.resize(b);var Fo,So,Co,Lo;E.setSize=q,E.setImg=A,E.rotateCW=d,E.rotateCCW=h,E.destroy=R}var r,s={size:[260,260],adaptive:null,outputSize:[0,0],outputType:"jpg",file:"",source:"",view:"",ok:"",loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){},lrzOption:{}},c="";return function(){var t,o={Webkit:"webkit",Moz:"",O:"o"},e=document.documentElement,n=function(o){return t?t+o:o.toLowerCase()};for(var i in o)if(void 0!==e.style[i+"TransitionProperty"]){c="-"+i.toLowerCase()+"-",t=o[i];break}r=n("TransitionEnd")}(),i});