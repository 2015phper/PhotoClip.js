/* PhotoClip v2.0.4 | Relying on the plug-in [jquery.js] [iscroll-zoom.js] [hammer.js] [lrz.all.bundle.js] */
!function(o,t){"use strict";"function"==typeof define&&define.amd?define(["jquery","iscroll-zoom","hammer","lrz"],t):"object"==typeof exports?module.exports=t(require("jquery"),require("iscroll-zoom"),require("hammer"),require("lrz")):o.PhotoClip=t(o.jQuery,o.IScroll,o.Hammer,o.lrz)}(this,function(o,t,e,n){"use strict";function i(t,e){var n=o.extend({},c,e);a.call(this,t,n)}function a(i,a){function c(){ft=!0,mt.append(this),k(st,function(){ct=this.naturalWidth,lt=this.naturalHeight},this),k(gt,function(){p()}),Z.call(I,this)}function u(){var o={zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"};Mt=new t(ht[0],o)}function p(){qt=0,At=0,Rt=0,ut=ct,pt=lt,mt.css({width:ct,height:lt}),C(mt,qt,At,Rt),f(ct,lt),Mt.zoom(Mt.options.zoomStart);var o=.5*(_-ct*Mt.scale),t=.5*(ot-lt*Mt.scale);Mt.scrollTo(o,t)}function f(o,t){M(o,t),Mt.scale<Mt.options.zoomMin&&Mt.zoom(Mt.options.zoomMin),gt.css({width:o,height:t}),ht.append(gt),Mt.refresh()}function d(){if(s){Tt=new e.Manager(gt[0]),Tt.add(new e.Rotate);var o,t;Tt.on("rotatemove",function(e){Lt||(o=e.rotation,o>180?o-=360:-180>o&&(o+=360),t=o>0?1:0>o?-1:0)}),Tt.on("rotateend",function(e){Lt||Math.abs(o)>30&&(1==t?h(e.center):-1==t&&g(e.center))})}else gt.on("dblclick",function(o){h({x:o.clientX,y:o.clientY})})}function h(o){m(90,o)}function g(o){m(-90,o)}function m(o,t){if(!Lt){Lt=!0;var e;e=t?w(gt,t.x,t.y):x(gt,ht,.5*_,.5*ot);var n=z(Rt,e),i=n.x,a=n.y,r=0,s=0,c=0,l=0,u=Rt+o;90==u||-270==u?(r=i+a,s=a-i,u>Rt?(c=lt-i-a,l=i-a):Rt>u&&(c=lt-a-(ct-i),l=i+a-lt),ut=lt,pt=ct):180==u||-180==u?(r=2*i,s=2*a,u>Rt?(c=ct-i-(lt-a),l=lt-(i+a)):Rt>u&&(c=ct-(i+a),l=lt-a-(ct-i)),ut=ct,pt=lt):270==u||-90==u?(r=i-a,s=i+a,u>Rt?(c=i+a-ct,l=ct-i-(lt-a)):Rt>u&&(c=a-i,l=ct-i-a),ut=lt,pt=ct):(0==u||360==u||-360==u)&&(r=0,s=0,u>Rt?(c=i-a,l=i+a-ct):Rt>u&&(c=i+a-lt,l=a-i),ut=ct,pt=lt),0==Rt?(qt=0,At=0):90==Rt||-270==Rt?(qt-=i+a,At-=a-i):180==Rt||-180==Rt?(qt-=2*i,At-=2*a):(270==Rt||-90==Rt)&&(qt-=i-a,At-=i+a),qt=qt.toFixed(2)-0,At=At.toFixed(2)-0,C(mt,qt,At,Rt,i,a),S(mt,qt,At,u,200,function(){Lt=!1,Rt=u%360,qt+=r+c,At+=s+l,qt=qt.toFixed(2)-0,At=At.toFixed(2)-0,C(mt,qt,At,Rt),Mt.scrollTo(Mt.x-c*Mt.scale,Mt.y-l*Mt.scale),f(ut,pt)})}}function v(){zt=document.createElement("canvas")}function b(){if(!ft)return console.log("当前没有图片可以裁剪!"),void G.call(I,null);var o=x(gt,ht),t=Mt.scale,e=zt.getContext("2d");e.clearRect(0,0,zt.width,zt.height),e.save(),nt&&it?(zt.width=nt,zt.height=it,e.scale(nt/_*t,it/ot*t)):(zt.width=_/t,zt.height=ot/t),e.translate(qt-o.x/t,At-o.y/t),e.rotate(Rt*Math.PI/180),e.drawImage(st[0],0,0),e.restore();try{var n=zt.toDataURL(H,O);vt.css("background-image","url("+n+")"),G.call(I,n)}catch(i){throw new Error("截图失败！当前图片源文件可能存在跨域问题，请确保图片与应用同源。如果您是在本地环境下执行本程序，请更换至服务器环境。")}}function y(){A()}function x(o,t,e,n){e=e||0,n=n||0;var i,a;return k(o,function(){i=o.offset()}),k(t,function(){a=t.offset()}),{x:a.left-i.left+e,y:a.top-i.top+n}}function w(o,t,e){t=t||0,e=e||0;var n;return k(o,function(){n=o.offset()}),{x:t+St.scrollLeft()-n.left,y:e+St.scrollTop()-n.top}}function k(t,e,n){var i=o();o.each(t,function(t,e){for(var n,a=e instanceof jQuery?e:o(e),r=a.parents().addBack().filter(":hidden"),t=r.length;t--&&a.is(":hidden");)n=r.eq(t),"none"===n.css("display")&&(i=i.add(n.show()))}),"function"==typeof e&&e.call(n||this),i.hide()}function z(o,t){var e=Mt.scale,n={};return 0==o?(n.x=t.x/e,n.y=t.y/e):90==o||-270==o?(n.x=t.y/e,n.y=lt-t.x/e):180==o||-180==o?(n.x=ct-t.x/e,n.y=lt-t.y/e):(270==o||-90==o)&&(n.x=ct-t.y/e,n.y=t.x/e),n}function T(o,t,e,n){var i=o/e,a=t/n;return i>a?i:a}function M(o,t){Mt.options.zoomMin=T(_,ot,o,t),Mt.options.zoomMax=Math.max(1,Mt.options.zoomMin),Mt.options.zoomStart=Math.min(Mt.options.zoomMax,T(Ft,jt,o,t))}function F(){st&&st.length&&(st.off(),st.remove(),delete st[0])}function j(t){F(),st=o("<img>").css({"user-select":"none","pointer-events":"none"}),at||(at=!0,Y.call(I,st[0])),st.on("load",c),st.attr("src",t)}function C(o,t,e,n,i,a){i=i||0,a=a||0;var r={};r[l+"transform"]="translateZ(0) translate("+t+"px,"+e+"px) rotate("+n+"deg)",r[l+"transform-origin"]=i+"px "+a+"px",o.css(r)}function S(o,t,e,n,i,a){o.css(l+"transform"),o.css(l+"transition",l+"transform "+i+"ms"),o.one(r,function(){o.css(l+"transition",""),a.call(this)}),o.css(l+"transform","translateZ(0) translate("+t+"px,"+e+"px) rotate("+n+"deg)")}function L(o){var t=o+"";return/%$/.test(t)}function q(){dt=o(i).css({"user-select":"none",overflow:"hidden"}),"static"==dt.css("position")&&dt.css("position","relative"),ht=o('<div class="photo-clip-view">').css({position:"absolute",left:"50%",top:"50%"}).appendTo(dt),gt=o('<div class="photo-clip-moveLayer">').appendTo(ht),mt=o('<div class="photo-clip-rotateLayer">').appendTo(gt);var t=o('<div class="photo-clip-mask">').css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo(dt);bt=o('<div class="photo-clip-mask-left">').css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto","background-color":"rgba(0,0,0,.5)"}).appendTo(t),yt=o('<div class="photo-clip-mask-right">').css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","background-color":"rgba(0,0,0,.5)"}).appendTo(t),xt=o('<div class="photo-clip-mask-top">').css({position:"absolute",left:0,right:0,top:0,bottom:"50%","background-color":"rgba(0,0,0,.5)"}).appendTo(t),wt=o('<div class="photo-clip-mask-bottom">').css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"background-color":"rgba(0,0,0,.5)"}).appendTo(t),kt=o('<div class="photo-clip-area">').css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%"}).appendTo(t),vt=o(U),vt.length&&vt.css({"background-color":"#666","background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}function A(o,t){var e=tt,n=et;if("number"==typeof o&&(tt=o),"number"==typeof t&&(et=t),_=tt,ot=et,(K||N)&&(V=tt/et),k(dt,function(){Ft=dt.width(),jt=dt.height()}),K&&(_=Ft/100*parseFloat(K),N||(ot=_/V)),N&&(ot=jt/100*parseFloat(N),K||(_=ot*V)),ht.css({width:_,height:ot,"margin-left":-_/2,"margin-top":-ot/2}),bt.css({"margin-right":_/2,"margin-top":-ot/2,"margin-bottom":-ot/2}),yt.css({"margin-left":_/2,"margin-top":-ot/2,"margin-bottom":-ot/2}),xt.css({"margin-bottom":ot/2}),wt.css({"margin-top":ot/2}),kt.css({width:_,height:ot,"margin-left":-_/2-1,"margin-top":-ot/2-1}),ut&&pt){var i=(_-e)/2*Mt.scale,a=(ot-n)/2*Mt.scale;Mt.scrollBy(i,a),f(ut,pt)}}function R(o){j(o)}function E(){rt.off("change"),rt=null,Tt?(Tt.off("rotatemove"),Tt.off("rotateend"),Tt.destroy(),Tt=null):gt.off("dblclick"),Mt.destroy(),Mt=null,dt.empty(),dt=null,ht=null,gt=null,mt=null,vt.css({"background-color":"","background-repeat":"","background-position":"","background-size":""}),vt=null}var I=this,W=a.size,P=a.adaptive,Q=a.outputSize,H=a.outputType||"image/jpeg",O=a.outputQuality,B=a.file,D=a.source,U=a.view,X=a.ok,Y=a.loadStart,Z=a.loadComplete,$=a.loadError,G=a.clipFinish,J=a.lrzOption;o.isArray(W)||(W=[260,260]),o.isArray(Q)||(Q=[0,0]);var K,N,V,_,ot,tt=W[0]||260,et=W[1]||260,nt=Math.max(Q[0],0),it=Math.max(Q[1],0);o.isArray(P)&&(P[0]&&(K=L(P[0])?P[0]:!1),P[1]&&(N=L(P[1])?P[1]:!1)),"jpg"===H?H="image/jpeg":"png"===H&&(H="image/png");var at=!1;if(B)if(window.FileReader){var rt=o(B);rt.length&&(s||rt.attr("accept","image/jpeg, image/x-png, image/gif"),rt.on("change",function(){if(this.files.length){var o=this.files[0];if(!/image\/\w+/.test(o.type))return console.log("图片格式不正确，请选择正确格式的图片文件！"),$.call(I,"Image format error"),!1;at||(at=!0,Y.call(I,o));var t=new FileReader;t.onprogress=function(o){console.log((o.loaded/o.total*100).toFixed()+"%")},t.onload=function(){n(o,J).then(function(o){j(o.base64),at=!1}).catch(function(o){console.log("图片处理失败"),$.call(I,o),at=!1})},t.onerror=function(o){console.log("图片加载失败"),$.call(I,o),at=!1},t.readAsDataURL(o)}}),rt.click(function(){this.value=""}))}else alert("您的浏览器不支持 HTML5 的 FileReader API，因此不能使用 file 控件上传图片！");D&&R(D);var st,ct,lt,ut,pt,ft,dt,ht,gt,mt,vt,bt,yt,xt,wt,kt,zt,Tt,Mt,Ft,jt;q(),u(),d(),v();var Ct=o(X);Ct.length&&Ct.click(function(){b()});var St=o(window);y(),St.resize(y);var Lt,qt,At,Rt;I.setSize=A,I.setImg=R,I.rotateCW=h,I.rotateCCW=g,I.destroy=E}var r,s=!!navigator.userAgent.match(/mobile/i),c={size:[260,260],adaptive:null,outputSize:[0,0],outputType:"jpg",outputQuality:.8,file:"",source:"",view:"",ok:"",loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){},lrzOption:{}},l="";return function(){var o,t={Webkit:"webkit",Moz:"",O:"o"},e=document.documentElement,n=function(t){return o?o+t:t.toLowerCase()};for(var i in t)if(void 0!==e.style[i+"TransitionProperty"]){l="-"+i.toLowerCase()+"-",o=t[i];break}r=n("TransitionEnd")}(),i});