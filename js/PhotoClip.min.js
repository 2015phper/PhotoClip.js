/* PhotoClip v2.0.1 | Relying on the plug-in [jquery.js] [iscroll-zoom.js] [hammer.js] [lrz.all.bundle.js] */
!function(t,o){"use strict";"function"==typeof define&&define.amd?define(["jquery","iscroll-zoom","hammer","lrz"],o):"object"==typeof exports?module.exports=o(require("jquery"),require("iscroll-zoom"),require("hammer"),require("lrz")):(t.bjj=t.bjj||{},t.bjj.PhotoClip=o(t.jQuery,t.IScroll,t.Hammer,t.lrz))}(this,function(t,o,e,n){"use strict";function i(o,e){if(!window.FileReader)return void alert("您的浏览器不支持 HTML5 的 FileReader API， 因此无法初始化图片裁剪插件，请更换最新的浏览器！");var n=t.extend({},s,e);a.call(this,o,n)}function a(i,a){function s(){uo=!0,mo.append(this),w(ao,function(){ro=this.naturalWidth,so=this.naturalHeight},this),w(ho,function(){u()}),X.call(E,this)}function l(){var t={zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"};To=new o(fo[0],t)}function u(){Lo=0,qo=0,Ao=0,co=ro,lo=so,mo.css({width:ro,height:so}),F(mo,Lo,qo,Ao),p(ro,so),To.zoom(To.options.zoomStart);var t=.5*(N-ro*To.scale),o=.5*(V-so*To.scale);To.scrollTo(t,o)}function p(t,o){T(t,o),To.scale<To.options.zoomMin&&To.zoom(To.options.zoomMin),ho.css({width:t,height:o}),fo.append(ho),To.refresh()}function f(){var t=!!navigator.userAgent.match(/mobile/i);if(t){zo=new e(ho[0]),zo.add(new e.Rotate);var o,n;zo.on("rotatemove",function(t){So||(o=t.rotation,o>180?o-=360:-180>o&&(o+=360),n=o>0?1:0>o?-1:0)}),zo.on("rotateend",function(t){So||Math.abs(o)>30&&(1==n?d(t.center):-1==n&&h(t.center))})}else ho.on("dblclick",function(t){d({x:t.clientX,y:t.clientY})})}function d(t){m(90,t)}function h(t){m(-90,t)}function m(t,o){if(!So){So=!0;var e;e=o?x(ho,o.x,o.y):y(ho,fo,.5*N,.5*V);var n=k(Ao,e),i=n.x,a=n.y,r=0,s=0,c=0,l=0,u=Ao+t;90==u||-270==u?(r=i+a,s=a-i,u>Ao?(c=so-i-a,l=i-a):Ao>u&&(c=so-a-(ro-i),l=i+a-so),co=so,lo=ro):180==u||-180==u?(r=2*i,s=2*a,u>Ao?(c=ro-i-(so-a),l=so-(i+a)):Ao>u&&(c=ro-(i+a),l=so-a-(ro-i)),co=ro,lo=so):270==u||-90==u?(r=i-a,s=i+a,u>Ao?(c=i+a-ro,l=ro-i-(so-a)):Ao>u&&(c=a-i,l=ro-i-a),co=so,lo=ro):(0==u||360==u||-360==u)&&(r=0,s=0,u>Ao?(c=i-a,l=i+a-ro):Ao>u&&(c=i+a-so,l=a-i),co=ro,lo=so),0==Ao?(Lo=0,qo=0):90==Ao||-270==Ao?(Lo-=i+a,qo-=a-i):180==Ao||-180==Ao?(Lo-=2*i,qo-=2*a):(270==Ao||-90==Ao)&&(Lo-=i-a,qo-=i+a),Lo=Lo.toFixed(2)-0,qo=qo.toFixed(2)-0,F(mo,Lo,qo,Ao,i,a),C(mo,Lo,qo,u,200,function(){So=!1,Ao=u%360,Lo+=r+c,qo+=s+l,Lo=Lo.toFixed(2)-0,qo=qo.toFixed(2)-0,F(mo,Lo,qo,Ao),To.scrollTo(To.x-c*To.scale,To.y-l*To.scale),p(co,lo)})}}function g(){ko=document.createElement("canvas")}function v(){if(!uo)return void alert("亲，当前没有图片可以裁剪!");var t=y(ho,fo),o=To.scale,e=ko.getContext("2d");e.clearRect(0,0,ko.width,ko.height),e.save(),oo&&eo?(ko.width=oo,ko.height=eo,e.scale(oo/N*o,eo/V*o)):(ko.width=N/o,ko.height=V/o),e.translate(Lo-t.x/o,qo-t.y/o),e.rotate(Ao*Math.PI/180),e.drawImage(ao[0],0,0),e.restore();try{var n=ko.toDataURL(H,1);go.css("background-image","url("+n+")"),Z.call(E,n)}catch(i){throw new Error("截图失败！当前图片源文件可能存在跨域问题，请确保图片与应用同源。如果您是在本地环境下执行本程序，请更换至服务器环境。")}}function b(){q()}function y(t,o,e,n){e=e||0,n=n||0;var i,a;return w(t,function(){i=t.offset()}),w(o,function(){a=o.offset()}),{x:a.left-i.left+e,y:a.top-i.top+n}}function x(t,o,e){o=o||0,e=e||0;var n;return w(t,function(){n=t.offset()}),{x:o+Co.scrollLeft()-n.left,y:e+Co.scrollTop()-n.top}}function w(o,e,n){var i=t();t.each(o,function(o,e){for(var n,a=e instanceof jQuery?e:t(e),r=a.parents().addBack().filter(":hidden"),o=r.length;o--&&a.is(":hidden");)n=r.eq(o),"none"===n.css("display")&&(i=i.add(n.show()))}),"function"==typeof e&&e.call(n||this),i.hide()}function k(t,o){var e=To.scale,n={};return 0==t?(n.x=o.x/e,n.y=o.y/e):90==t||-270==t?(n.x=o.y/e,n.y=so-o.x/e):180==t||-180==t?(n.x=ro-o.x/e,n.y=so-o.y/e):(270==t||-90==t)&&(n.x=ro-o.y/e,n.y=o.x/e),n}function z(t,o,e,n){var i=t/e,a=o/n;return i>a?i:a}function T(t,o){To.options.zoomMin=z(N,V,t,o),To.options.zoomMax=Math.max(1,To.options.zoomMin),To.options.zoomStart=Math.min(To.options.zoomMax,z(jo,Mo,t,o))}function j(){ao&&ao.length&&(ao.off(),ao.remove(),delete ao[0])}function M(o){j(),ao=t("<img>").css({"user-select":"none","pointer-events":"none"}),no||(no=!0,U.call(E,ao[0])),ao.on("load",s),ao.attr("src",o)}function F(t,o,e,n,i,a){i=i||0,a=a||0;var r={};r[c+"transform"]="translateZ(0) translate("+o+"px,"+e+"px) rotate("+n+"deg)",r[c+"transform-origin"]=i+"px "+a+"px",t.css(r)}function C(t,o,e,n,i,a){t.css(c+"transform"),t.css(c+"transition",c+"transform "+i+"ms"),t.one(r,function(){t.css(c+"transition",""),a.call(this)}),t.css(c+"transform","translateZ(0) translate("+o+"px,"+e+"px) rotate("+n+"deg)")}function S(t){var o=t+"";return/%$/.test(o)}function L(){po=t(i).css({"user-select":"none",overflow:"hidden"}),"static"==po.css("position")&&po.css("position","relative"),fo=t("<div class='photo-clip-view'>").css({position:"absolute",left:"50%",top:"50%"}).appendTo(po),ho=t("<div class='photo-clip-moveLayer'>").appendTo(fo),mo=t("<div class='photo-clip-rotateLayer'>").appendTo(ho);var o=t("<div class='photo-clip-mask'>").css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo(po);vo=t("<div class='photo-clip-mask-left'>").css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto","background-color":"rgba(0,0,0,.5)"}).appendTo(o),bo=t("<div class='photo-clip-mask-right'>").css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","background-color":"rgba(0,0,0,.5)"}).appendTo(o),yo=t("<div class='photo-clip-mask-top'>").css({position:"absolute",left:0,right:0,top:0,bottom:"50%","background-color":"rgba(0,0,0,.5)"}).appendTo(o),xo=t("<div class='photo-clip-mask-bottom'>").css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),wo=t("<div class='photo-clip-area'>").css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%"}).appendTo(o),go=t(D),go.length&&go.css({"background-color":"#666","background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}function q(t,o){var e=_,n=to;if("number"==typeof t&&(_=t),"number"==typeof o&&(to=o),N=_,V=to,(G||J)&&(K=_/to),w(po,function(){jo=po.width(),Mo=po.height()}),G&&(N=jo/100*parseFloat(G),J||(V=N/K)),J&&(V=Mo/100*parseFloat(J),G||(N=V*K)),fo.css({width:N,height:V,"margin-left":-N/2,"margin-top":-V/2}),vo.css({"margin-right":N/2,"margin-top":-V/2,"margin-bottom":-V/2}),bo.css({"margin-left":N/2,"margin-top":-V/2,"margin-bottom":-V/2}),yo.css({"margin-bottom":V/2}),xo.css({"margin-top":V/2}),wo.css({width:N,height:V,"margin-left":-N/2-1,"margin-top":-V/2-1}),co&&lo){var i=(N-e)/2*To.scale,a=(V-n)/2*To.scale;To.scrollBy(i,a),p(co,lo)}}function A(t){M(t)}function R(){io.off("change"),io=null,zo?(zo.off("rotatemove"),zo.off("rotateend"),zo.destroy(),zo=null):ho.off("dblclick"),To.destroy(),To=null,po.empty(),po=null,fo=null,ho=null,mo=null,go.css({"background-color":"","background-repeat":"","background-position":"","background-size":""}),go=null}var E=this,I=a.size,W=a.adaptive,P=a.outputSize,H=a.outputType||"image/jpeg",O=a.file,B=a.source,D=a.view,Q=a.ok,U=a.loadStart,X=a.loadComplete,Y=a.loadError,Z=a.clipFinish,$=a.lrzOption;t.isArray(I)||(I=[260,260]),t.isArray(P)||(P=[0,0]);var G,J,K,N,V,_=I[0]||260,to=I[1]||260,oo=Math.max(P[0],0),eo=Math.max(P[1],0);t.isArray(W)&&(W[0]&&(G=S(W[0])?W[0]:!1),W[1]&&(J=S(W[1])?W[1]:!1)),"jpg"===H?H="image/jpeg":"png"===H&&(H="image/png");var no=!1,io=t(O);io.length&&(io.attr("accept","image/jpeg, image/x-png, image/gif"),io.on("change",function(){if(this.files.length){var t=this.files[0];if(!/image\/\w+/.test(t.type))return alert("图片格式不正确，请选择正确格式的图片文件！"),!1;no||(no=!0,U.call(E,t));var o=new FileReader;o.onprogress=function(t){console.log((t.loaded/t.total*100).toFixed()+"%")},o.onload=function(){n(t,$).then(function(t){M(t.base64),no=!1}).catch(function(t){alert("图片处理失败"),Y.call(E,t),no=!1})},o.onerror=function(t){alert("图片加载失败"),Y.call(E,t),no=!1},o.readAsDataURL(t)}}),io.click(function(){this.value=""})),B&&A(B);var ao,ro,so,co,lo,uo,po,fo,ho,mo,go,vo,bo,yo,xo,wo,ko,zo,To,jo,Mo;L(),l(),f(),g();var Fo=t(Q);Fo.length&&Fo.click(function(){v()});var Co=t(window);b(),Co.resize(b);var So,Lo,qo,Ao;E.setSize=q,E.setImg=A,E.rotateCW=d,E.rotateCCW=h,E.destroy=R}var r,s={size:[260,260],adaptive:null,outputSize:[0,0],outputType:"jpg",file:"",source:"",view:"",ok:"",loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){},lrzOption:{}},c="";return function(){var t,o={Webkit:"webkit",Moz:"",O:"o"},e=document.documentElement,n=function(o){return t?t+o:o.toLowerCase()};for(var i in o)if(void 0!==e.style[i+"TransitionProperty"]){c="-"+i.toLowerCase()+"-",t=o[i];break}r=n("TransitionEnd")}(),i});