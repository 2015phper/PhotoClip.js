!function(){function t(t,o){function i(){W=!0,X.append(this),m.call(this,C,function(){A=this.naturalWidth,E=this.naturalHeight}),m(U,function(){e()}),R.call(this,this.src)}function n(){var t={zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"};q=new IScroll(P[0],t)}function e(){K=0,N=0,O=0,X.css({width:A,height:E,"transform-origin":"0 0",transform:"translateZ(0px)",x:K,y:N,rotate:O}),x(A,E),q.zoom(q.options.zoomStart),a(A,E);var t=.5*(k-A*q.options.zoomStart),o=.5*(z-E*q.options.zoomStart);q.scrollTo(t,o)}function a(t,o){U.css({width:t,height:o}),P.append(U),q.refresh()}function r(){var t=!!navigator.userAgent.match(/mobile/i);if(t){var o=new Hammer(U[0]);o.add(new Hammer.Rotate);var i,n;o.on("rotatemove",function(t){J||(i=t.rotation,i>180?i-=360:-180>i&&(i+=360),n=i>0?1:0>i?-1:0)}),o.on("rotateend",function(t){J||Math.abs(i)>30&&(1==n?s(t.center):-1==n&&l(t.center))})}else U.on("dblclick",function(t){s({x:t.clientX,y:t.clientY})})}function s(t){c(90,t)}function l(t){c(-90,t)}function c(t,o){if(!J){J=!0;var i;i=o?u(U,o.x,o.y):f(U,P,.5*k,.5*z);var n,e,r=g(O,i),s=r.x,l=r.y,c=0,h=0,d=0,p=0,m=O+t;90==m||-270==m?(c=s+l,h=l-s,m>O?(d=E-s-l,p=s-l):O>m&&(d=E-l-(A-s),p=s+l-E),n=E,e=A):180==m||-180==m?(c=2*s,h=2*l,m>O?(d=A-s-(E-l),p=E-(s+l)):O>m&&(d=A-(s+l),p=E-l-(A-s)),n=A,e=E):270==m||-90==m?(c=s-l,h=s+l,m>O?(d=s+l-A,p=A-s-(E-l)):O>m&&(d=l-s,p=A-s-l),n=E,e=A):(0==m||360==m||-360==m)&&(c=0,h=0,m>O?(d=s-l,p=s+l-A):O>m&&(d=s+l-E,p=l-s),n=A,e=E),0==O?(K=0,N=0):90==O||-270==O?(K-=s+l,N-=l-s):180==O||-180==O?(K-=2*s,N-=2*l):(270==O||-90==O)&&(K-=s-l,N-=s+l),K=K.toFixed(2)-0,N=N.toFixed(2)-0,X.css({"transform-origin":s+"px "+l+"px",x:K,y:N}),X.transition({rotate:m},200,function(){J=!1,O=m%360,K+=c+d,N+=h+p,K=K.toFixed(2)-0,N=N.toFixed(2)-0,X.css({"transform-origin":"0 0",x:K,y:N,rotate:O}),q.scrollTo(q.x-d*q.scale,q.y-p*q.scale),x(n,e),q.scale<q.options.zoomMin&&q.zoom(q.options.zoomMin),a(n,e)})}}function h(){j=document.createElement("canvas"),j.width=k,j.height=z}function d(){if(!W)return void alert("亲，当前没有图片可以裁剪!");var t=f(U,P),o=q.scale,i=j.getContext("2d");i.clearRect(0,0,j.width,j.height),i.save(),i.scale(o,o),i.translate(K-t.x/o,N-t.y/o),i.rotate(O*Math.PI/180),i.drawImage(C[0],0,0),i.restore();var n=j.toDataURL();Y.css("background-image","url("+n+")"),H.call(C[0],n)}function p(){m(D,function(){Z=D.width(),B=D.height()})}function f(t,o,i,n){i=i||0,n=n||0;var e,a;return m(t,function(){e=t.offset()}),m(o,function(){a=o.offset()}),{x:a.left-e.left+i,y:a.top-e.top+n}}function u(t,o,i){o=o||0,i=i||0;var n;return m(t,function(){n=t.offset()}),{x:o+G.scrollLeft()-n.left,y:i+G.scrollTop()-n.top}}function m(t,o){var i=$();$.each(t,function(t,o){for(var n,e=$(o),a=e.parents().andSelf().filter(":hidden"),t=0;t<a.length&&e.is(":hidden");t++)n=a.eq(t),"none"==n.css("display")&&(i=i.add(n.show()))}),"function"==typeof o&&o.call(this),i.hide()}function g(t,o){var i=q.scale,n={};return 0==t?(n.x=o.x/i,n.y=o.y/i):90==t||-270==t?(n.x=o.y/i,n.y=E-o.x/i):180==t||-180==t?(n.x=A-o.x/i,n.y=E-o.y/i):(270==t||-90==t)&&(n.x=A-o.y/i,n.y=o.x/i),n}function v(t,o,i,n){var e=t/i,a=o/n;return e>a?e:a}function x(t,o){q.options.zoomMin=v(k,z,t,o),q.options.zoomMax=Math.max(1,q.options.zoomMin),q.options.zoomStart=Math.min(q.options.zoomMax,v(Z,B,t,o))}function b(t,o,i,n){o=o||.8,i=i||0;var e="image/jpeg";void 0!=n&&"png"==n&&(e="image/png");var a=t.naturalWidth,r=t.naturalHeight,s=Math.max(a,r);s>1024&&(minSide=Math.min(a,r),minSide=minSide/s*1024,s=1024,a>r?(a=s,r=minSide):(a=minSide,r=s));var l=document.createElement("canvas"),c=l.getContext("2d");90==i?(l.width=r,l.height=a,c.translate(r,0),c.rotate(.5*Math.PI)):(l.width=a,l.height=r),c.drawImage(t,0,0,a,r);var h=l.toDataURL(e,o||.8);return h}function w(t){C&&C.length&&(C.remove(),delete C[0]),C=$("<img>").css({"user-select":"none","pointer-events":"none"}),C.load(i),C.attr("src",t)}function y(){D=$(t).css({"user-select":"none",overflow:"hidden"}),"static"==D.css("position")&&D.css("position","relative"),P=$("<div class='photo-clip-view'>").css({position:"absolute",left:"50%",top:"50%",width:k,height:z,"margin-left":-k/2,"margin-top":-z/2}).appendTo(D),U=$("<div class='photo-clip-moveLayer'>").appendTo(P),X=$("<div class='photo-clip-rotateLayer'>").appendTo(U);{var o=$("<div class='photo-clip-mask'>").css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo(D);$("<div class='photo-clip-mask-left'>").css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto",height:z,"margin-right":k/2,"margin-top":-z/2,"margin-bottom":-z/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),$("<div class='photo-clip-mask-right'>").css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","margin-left":k/2,"margin-top":-z/2,"margin-bottom":-z/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),$("<div class='photo-clip-mask-top'>").css({position:"absolute",left:0,right:0,top:0,bottom:"50%","margin-bottom":z/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),$("<div class='photo-clip-mask-bottom'>").css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"margin-top":z/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),$("<div class='photo-clip-area'>").css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%",width:k,height:z,"margin-left":-k/2-1,"margin-top":-z/2-1}).appendTo(o)}Y=$(S),Y.length&&Y.css({"background-color":"#666","background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}var k=o.width,z=o.height,M=o.file,S=o.view,T=o.ok,F=o.loadStart,R=o.loadComplete,L=o.loadError,H=o.clipFinish,I=$(M);if(I.length){var C,A,E,W;I.attr("accept","image/*"),I.change(function(){if(this.files.length){if(!/image\/\w+/.test(this.files[0].type))return alert("图片格式不正确，请选择正确格式的图片文件！"),!1;var t=new FileReader;t.onprogress=function(t){console.log((t.loaded/t.total*100).toFixed()+"%")},t.onload=function(t){var o=t.total/1024;if(o>1024){var i=1024/o,n=$("<img>").hide();n.load(function(){var t=this.naturalWidth;n.appendTo(document.body);var o=this.naturalHeight;n.remove(),delete n[0],n=null;var e=0;t==o&&(e=90);var a=b(this,i,e);w(a)}),n.attr("src",this.result)}else w(this.result)},t.onerror=function(t){alert("图片加载失败"),L.call(this,t)},t.readAsDataURL(this.files[0]),F.call(t,this.files[0])}});var D,P,U,X,Y,j,q,Z,B;y(),n(),r(),h(),$ok=$(T),$ok.length&&$ok.click(function(){d()});var G=$(window);p(),G.resize(p);var J,K,N,O}}$.fn.photoClip=function(o){if(!window.FileReader)return void alert("您的浏览器不支持 HTML5 的 FileReader API， 因此无法初始化图片裁剪插件，请更换最新的浏览器！");var i={width:100,height:100,file:"",view:"",ok:"",loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){}};return $.extend(i,o),this.each(function(){t(this,i)}),this}}();