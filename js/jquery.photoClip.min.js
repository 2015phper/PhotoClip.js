/* jQuery photoClip v1.3 | Relying on the plug-in [jquery.transit.js] [iscroll-zoom.js] [hammer.js] */
!function(t){"use strict";function o(o,i){function e(){D=!0,Y.append(this),g.call(this,E,function(){W=this.naturalWidth,j=this.naturalHeight}),g(X,function(){a()}),H.call(this,this.src)}function n(){var t={zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"};Z=new IScroll(U[0],t)}function a(){O=0,V=0,$=0,Y.css({width:W,height:j,"transform-origin":"0 0",transform:"translateZ(0px)",x:O,y:V,rotate:$}),b(W,j),Z.zoom(Z.options.zoomStart),r(W,j);var t=.5*(z-W*Z.options.zoomStart),o=.5*(S-j*Z.options.zoomStart);Z.scrollTo(t,o)}function r(t,o){X.css({width:t,height:o}),U.append(X),Z.refresh()}function s(){var t=!!navigator.userAgent.match(/mobile/i);if(t){var o=new Hammer(X[0]);o.add(new Hammer.Rotate);var i,e;o.on("rotatemove",function(t){N||(i=t.rotation,i>180?i-=360:-180>i&&(i+=360),e=i>0?1:0>i?-1:0)}),o.on("rotateend",function(t){N||Math.abs(i)>30&&(1==e?c(t.center):-1==e&&l(t.center))})}else X.on("dblclick",function(t){c({x:t.clientX,y:t.clientY})})}function c(t){h(90,t)}function l(t){h(-90,t)}function h(t,o){if(!N){N=!0;var i;i=o?m(X,o.x,o.y):u(X,U,.5*z,.5*S);var e,n,a=v($,i),s=a.x,c=a.y,l=0,h=0,d=0,p=0,f=$+t;90==f||-270==f?(l=s+c,h=c-s,f>$?(d=j-s-c,p=s-c):$>f&&(d=j-c-(W-s),p=s+c-j),e=j,n=W):180==f||-180==f?(l=2*s,h=2*c,f>$?(d=W-s-(j-c),p=j-(s+c)):$>f&&(d=W-(s+c),p=j-c-(W-s)),e=W,n=j):270==f||-90==f?(l=s-c,h=s+c,f>$?(d=s+c-W,p=W-s-(j-c)):$>f&&(d=c-s,p=W-s-c),e=j,n=W):(0==f||360==f||-360==f)&&(l=0,h=0,f>$?(d=s-c,p=s+c-W):$>f&&(d=s+c-j,p=c-s),e=W,n=j),0==$?(O=0,V=0):90==$||-270==$?(O-=s+c,V-=c-s):180==$||-180==$?(O-=2*s,V-=2*c):(270==$||-90==$)&&(O-=s-c,V-=s+c),O=O.toFixed(2)-0,V=V.toFixed(2)-0,Y.css({"transform-origin":s+"px "+c+"px",x:O,y:V}),Y.transition({rotate:f},200,function(){N=!1,$=f%360,O+=l+d,V+=h+p,O=O.toFixed(2)-0,V=V.toFixed(2)-0,Y.css({"transform-origin":"0 0",x:O,y:V,rotate:$}),Z.scrollTo(Z.x-d*Z.scale,Z.y-p*Z.scale),b(e,n),Z.scale<Z.options.zoomMin&&Z.zoom(Z.options.zoomMin),r(e,n)})}}function d(){Q=document.createElement("canvas"),Q.width=z,Q.height=S}function p(){if(!D)return void alert("亲，当前没有图片可以裁剪!");var t=u(X,U),o=Z.scale,i=Q.getContext("2d");i.clearRect(0,0,Q.width,Q.height),i.save(),R?i.scale(o,o):(Q.width=z/o,Q.height=S/o),i.translate(O-t.x/o,V-t.y/o),i.rotate($*Math.PI/180),i.drawImage(E[0],0,0),i.restore();var e=Q.toDataURL("image/jpeg");q.css("background-image","url("+e+")"),C.call(E[0],e)}function f(){g(P,function(){B=P.width(),G=P.height()})}function u(t,o,i,e){i=i||0,e=e||0;var n,a;return g(t,function(){n=t.offset()}),g(o,function(){a=o.offset()}),{x:a.left-n.left+i,y:a.top-n.top+e}}function m(t,o,i){o=o||0,i=i||0;var e;return g(t,function(){e=t.offset()}),{x:o+K.scrollLeft()-e.left,y:i+K.scrollTop()-e.top}}function g(o,i){var e=t();t.each(o,function(o,i){for(var n,a=t(i),r=a.parents().andSelf().filter(":hidden"),o=0;o<r.length&&a.is(":hidden");o++)n=r.eq(o),"none"==n.css("display")&&(e=e.add(n.show()))}),"function"==typeof i&&i.call(this),e.hide()}function v(t,o){var i=Z.scale,e={};return 0==t?(e.x=o.x/i,e.y=o.y/i):90==t||-270==t?(e.x=o.y/i,e.y=j-o.x/i):180==t||-180==t?(e.x=W-o.x/i,e.y=j-o.y/i):(270==t||-90==t)&&(e.x=W-o.y/i,e.y=o.x/i),e}function x(t,o,i,e){var n=t/i,a=o/e;return n>a?n:a}function b(t,o){Z.options.zoomMin=x(z,S,t,o),Z.options.zoomMax=Math.max(1,Z.options.zoomMin),Z.options.zoomStart=Math.min(Z.options.zoomMax,x(B,G,t,o))}function w(t,o,i,e){o=o||.8,i=i||0;var n="image/jpeg";void 0!=e&&"png"==e&&(n="image/png");var a=t.naturalWidth,r=t.naturalHeight,s=Math.max(a,r);s>1024&&(minSide=Math.min(a,r),minSide=minSide/s*1024,s=1024,a>r?(a=s,r=minSide):(a=minSide,r=s));var c=document.createElement("canvas"),l=c.getContext("2d");i?(c.width=r,c.height=a,l.translate(r,0),l.rotate(i*Math.PI/180)):(c.width=a,c.height=r),l.drawImage(t,0,0,a,r);var h=c.toDataURL(n,o||.8);return h}function y(o){E&&E.length&&(E.remove(),delete E[0]),E=t("<img>").css({"user-select":"none","pointer-events":"none"}),E.load(e),E.attr("src",o)}function k(){P=t(o).css({"user-select":"none",overflow:"hidden"}),"static"==P.css("position")&&P.css("position","relative"),U=t("<div class='photo-clip-view'>").css({position:"absolute",left:"50%",top:"50%",width:z,height:S,"margin-left":-z/2,"margin-top":-S/2}).appendTo(P),X=t("<div class='photo-clip-moveLayer'>").appendTo(U),Y=t("<div class='photo-clip-rotateLayer'>").appendTo(X);{var i=t("<div class='photo-clip-mask'>").css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo(P);t("<div class='photo-clip-mask-left'>").css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto",height:S,"margin-right":z/2,"margin-top":-S/2,"margin-bottom":-S/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(i),t("<div class='photo-clip-mask-right'>").css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","margin-left":z/2,"margin-top":-S/2,"margin-bottom":-S/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(i),t("<div class='photo-clip-mask-top'>").css({position:"absolute",left:0,right:0,top:0,bottom:"50%","margin-bottom":S/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(i),t("<div class='photo-clip-mask-bottom'>").css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"margin-top":S/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(i),t("<div class='photo-clip-area'>").css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%",width:z,height:S,"margin-left":-z/2-1,"margin-top":-S/2-1}).appendTo(i)}q=t(T),q.length&&q.css({"background-color":"#666","background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}var z=i.width,S=i.height,M=i.file,T=i.view,F=i.ok,R=i.strictSize,L=i.loadStart,H=i.loadComplete,I=i.loadError,C=i.clipFinish,A=t(M);if(A.length){var E,W,j,D;A.attr("accept","image/*"),A.change(function(){if(this.files.length){if(!/image\/\w+/.test(this.files[0].type))return alert("图片格式不正确，请选择正确格式的图片文件！"),!1;var o=new FileReader;o.onprogress=function(t){console.log((t.loaded/t.total*100).toFixed()+"%")},o.onload=function(o){var i=o.total/1024;if(i>1024){var e=1024/i,n=t("<img>").hide();n.load(function(){var t=this.naturalWidth;n.appendTo(document.body);var o=this.naturalHeight;n.remove(),delete n[0],n=null;var i=0;t==o&&(i=90);var a=w(this,e,i);y(a)}),n.attr("src",this.result)}else y(this.result)},o.onerror=function(t){alert("图片加载失败"),I.call(this,t)},o.readAsDataURL(this.files[0]),L.call(o,this.files[0])}}),A.click(function(){this.value=""});var P,U,X,Y,q,Q,Z,B,G;k(),n(),s(),d();var J=t(F);J.length&&J.click(function(){p()});var K=t(window);f(),K.resize(f);var N,O,V,$}}t.fn.photoClip=function(i){if(!window.FileReader)return void alert("您的浏览器不支持 HTML5 的 FileReader API， 因此无法初始化图片裁剪插件，请更换最新的浏览器！");var e={width:100,height:100,file:"",view:"",ok:"",strictSize:!1,loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){}};return t.extend(e,i),this.each(function(){o(this,e)}),this}}(jQuery);