/**
 * jQuery photoClip v1.2
 * 依赖插件
 * - jquery.transit.js
 * - iscroll-zoom.js
 * - hammer.js
 *
 * @author 白俊杰 625603381@qq.com 2014/07/31
 * https://github.com/baijunjie/jQuery-photoClip
 *
 * @brief	支持手势的裁图插件
 *			在移动设备上双指捏合为缩放，双指旋转可根据旋转方向每次旋转90度
 *			在PC设备上鼠标滚轮为缩放，每次双击则顺时针旋转90度
 */
!function(t){function o(o,i){function e(){j=!0,$.append(this),g.call(this,A,function(){E=this.naturalWidth,W=this.naturalHeight}),g(U,function(){a()}),L.call(this,this.src)}function n(){var t={zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"};q=new IScroll(P[0],t)}function a(){J=0,K=0,N=0,$.css({width:E,height:W,"transform-origin":"0 0",transform:"translateZ(0px)",x:J,y:K,rotate:N}),b(E,W),q.zoom(q.options.zoomStart),r(E,W);var t=.5*(z-E*q.options.zoomStart),o=.5*(M-W*q.options.zoomStart);q.scrollTo(t,o)}function r(t,o){U.css({width:t,height:o}),P.append(U),q.refresh()}function s(){var t=!!navigator.userAgent.match(/mobile/i);if(t){var o=new Hammer(U[0]);o.add(new Hammer.Rotate);var i,e;o.on("rotatemove",function(t){G||(i=t.rotation,i>180?i-=360:-180>i&&(i+=360),e=i>0?1:0>i?-1:0)}),o.on("rotateend",function(t){G||Math.abs(i)>30&&(1==e?c(t.center):-1==e&&l(t.center))})}else U.on("dblclick",function(t){c({x:t.clientX,y:t.clientY})})}function c(t){h(90,t)}function l(t){h(-90,t)}function h(t,o){if(!G){G=!0;var i;i=o?m(U,o.x,o.y):u(U,P,.5*z,.5*M);var e,n,a=v(N,i),s=a.x,c=a.y,l=0,h=0,d=0,p=0,f=N+t;90==f||-270==f?(l=s+c,h=c-s,f>N?(d=W-s-c,p=s-c):N>f&&(d=W-c-(E-s),p=s+c-W),e=W,n=E):180==f||-180==f?(l=2*s,h=2*c,f>N?(d=E-s-(W-c),p=W-(s+c)):N>f&&(d=E-(s+c),p=W-c-(E-s)),e=E,n=W):270==f||-90==f?(l=s-c,h=s+c,f>N?(d=s+c-E,p=E-s-(W-c)):N>f&&(d=c-s,p=E-s-c),e=W,n=E):(0==f||360==f||-360==f)&&(l=0,h=0,f>N?(d=s-c,p=s+c-E):N>f&&(d=s+c-W,p=c-s),e=E,n=W),0==N?(J=0,K=0):90==N||-270==N?(J-=s+c,K-=c-s):180==N||-180==N?(J-=2*s,K-=2*c):(270==N||-90==N)&&(J-=s-c,K-=s+c),J=J.toFixed(2)-0,K=K.toFixed(2)-0,$.css({"transform-origin":s+"px "+c+"px",x:J,y:K}),$.transition({rotate:f},200,function(){G=!1,N=f%360,J+=l+d,K+=h+p,J=J.toFixed(2)-0,K=K.toFixed(2)-0,$.css({"transform-origin":"0 0",x:J,y:K,rotate:N}),q.scrollTo(q.x-d*q.scale,q.y-p*q.scale),b(e,n),q.scale<q.options.zoomMin&&q.zoom(q.options.zoomMin),r(e,n)})}}function d(){Y=document.createElement("canvas"),Y.width=z,Y.height=M}function p(){if(!j)return void alert("亲，当前没有图片可以裁剪!");var t=u(U,P),o=q.scale,i=Y.getContext("2d");i.clearRect(0,0,Y.width,Y.height),i.save(),i.scale(o,o),i.translate(J-t.x/o,K-t.y/o),i.rotate(N*Math.PI/180),i.drawImage(A[0],0,0),i.restore();var e=Y.toDataURL("image/jpeg");X.css("background-image","url("+e+")"),I.call(A[0],e)}function f(){g(D,function(){Q=D.width(),Z=D.height()})}function u(t,o,i,e){i=i||0,e=e||0;var n,a;return g(t,function(){n=t.offset()}),g(o,function(){a=o.offset()}),{x:a.left-n.left+i,y:a.top-n.top+e}}function m(t,o,i){o=o||0,i=i||0;var e;return g(t,function(){e=t.offset()}),{x:o+B.scrollLeft()-e.left,y:i+B.scrollTop()-e.top}}function g(o,i){var e=t();t.each(o,function(o,i){for(var n,a=t(i),r=a.parents().andSelf().filter(":hidden"),o=0;o<r.length&&a.is(":hidden");o++)n=r.eq(o),"none"==n.css("display")&&(e=e.add(n.show()))}),"function"==typeof i&&i.call(this),e.hide()}function v(t,o){var i=q.scale,e={};return 0==t?(e.x=o.x/i,e.y=o.y/i):90==t||-270==t?(e.x=o.y/i,e.y=W-o.x/i):180==t||-180==t?(e.x=E-o.x/i,e.y=W-o.y/i):(270==t||-90==t)&&(e.x=E-o.y/i,e.y=o.x/i),e}function x(t,o,i,e){var n=t/i,a=o/e;return n>a?n:a}function b(t,o){q.options.zoomMin=x(z,M,t,o),q.options.zoomMax=Math.max(1,q.options.zoomMin),q.options.zoomStart=Math.min(q.options.zoomMax,x(Q,Z,t,o))}function w(t,o,i,e){o=o||.8,i=i||0;var n="image/jpeg";void 0!=e&&"png"==e&&(n="image/png");var a=t.naturalWidth,r=t.naturalHeight,s=Math.max(a,r);s>1024&&(minSide=Math.min(a,r),minSide=minSide/s*1024,s=1024,a>r?(a=s,r=minSide):(a=minSide,r=s));var c=document.createElement("canvas"),l=c.getContext("2d");90==i?(c.width=r,c.height=a,l.translate(r,0),l.rotate(.5*Math.PI)):(c.width=a,c.height=r),l.drawImage(t,0,0,a,r);var h=c.toDataURL(n,o||.8);return h}function y(o){A&&A.length&&(A.remove(),delete A[0]),A=t("<img>").css({"user-select":"none","pointer-events":"none"}),A.load(e),A.attr("src",o)}function k(){D=t(o).css({"user-select":"none",overflow:"hidden"}),"static"==D.css("position")&&D.css("position","relative"),P=t("<div class='photo-clip-view'>").css({position:"absolute",left:"50%",top:"50%",width:z,height:M,"margin-left":-z/2,"margin-top":-M/2}).appendTo(D),U=t("<div class='photo-clip-moveLayer'>").appendTo(P),$=t("<div class='photo-clip-rotateLayer'>").appendTo(U);{var i=t("<div class='photo-clip-mask'>").css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo(D);t("<div class='photo-clip-mask-left'>").css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto",height:M,"margin-right":z/2,"margin-top":-M/2,"margin-bottom":-M/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(i),t("<div class='photo-clip-mask-right'>").css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","margin-left":z/2,"margin-top":-M/2,"margin-bottom":-M/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(i),t("<div class='photo-clip-mask-top'>").css({position:"absolute",left:0,right:0,top:0,bottom:"50%","margin-bottom":M/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(i),t("<div class='photo-clip-mask-bottom'>").css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"margin-top":M/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(i),t("<div class='photo-clip-area'>").css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%",width:z,height:M,"margin-left":-z/2-1,"margin-top":-M/2-1}).appendTo(i)}X=t(T),X.length&&X.css({"background-color":"#666","background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}var z=i.width,M=i.height,S=i.file,T=i.view,F=i.ok,R=i.loadStart,L=i.loadComplete,H=i.loadError,I=i.clipFinish,C=t(S);if(C.length){var A,E,W,j;C.attr("accept","image/*"),C.change(function(){if(this.files.length){if(!/image\/\w+/.test(this.files[0].type))return alert("图片格式不正确，请选择正确格式的图片文件！"),!1;var o=new FileReader;o.onprogress=function(t){console.log((t.loaded/t.total*100).toFixed()+"%")},o.onload=function(o){var i=o.total/1024;if(i>1024){var e=1024/i,n=t("<img>").hide();n.load(function(){var t=this.naturalWidth;n.appendTo(document.body);var o=this.naturalHeight;n.remove(),delete n[0],n=null;var i=0;t==o&&(i=90);var a=w(this,e,i);y(a)}),n.attr("src",this.result)}else y(this.result)},o.onerror=function(t){alert("图片加载失败"),H.call(this,t)},o.readAsDataURL(this.files[0]),R.call(o,this.files[0])}}),C.click(function(){this.value=""});var D,P,U,$,X,Y,q,Q,Z;k(),n(),s(),d(),$ok=t(F),$ok.length&&$ok.click(function(){p()});var B=t(window);f(),B.resize(f);var G,J,K,N}}t.fn.photoClip=function(i){if(!window.FileReader)return void alert("您的浏览器不支持 HTML5 的 FileReader API， 因此无法初始化图片裁剪插件，请更换最新的浏览器！");var e={width:100,height:100,file:"",view:"",ok:"",loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){}};return t.extend(e,i),this.each(function(){o(this,e)}),this}}(jQuery);