/* jQuery photoClip v1.4 | Relying on the plug-in [iscroll-zoom.js] [hammer.js] */
!function(t){"use strict";function o(o,i){function a(){Y=!0,Q.append(this),b.call(this,D,function(){U=this.naturalWidth,X=this.naturalHeight}),b(O,function(){s()}),W.call(this,this.src)}function r(){var t={zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"};J=new IScroll(q[0],t)}function s(){to=0,oo=0,no=0,Q.css({width:U,height:X}),T(Q,to,oo,no),y(U,X),J.zoom(J.options.zoomStart),c(U,X);var t=.5*(F-U*J.options.zoomStart),o=.5*(L-X*J.options.zoomStart);J.scrollTo(t,o)}function c(t,o){O.css({width:t,height:o}),q.append(O),J.refresh()}function l(){var t=!!navigator.userAgent.match(/mobile/i);if(t){var o=new Hammer(O[0]);o.add(new Hammer.Rotate);var n,e;o.on("rotatemove",function(t){_||(n=t.rotation,n>180?n-=360:-180>n&&(n+=360),e=n>0?1:0>n?-1:0)}),o.on("rotateend",function(t){_||Math.abs(n)>30&&(1==e?h(t.center):-1==e&&d(t.center))})}else O.on("dblclick",function(t){h({x:t.clientX,y:t.clientY})})}function h(t){p(90,t)}function d(t){p(-90,t)}function p(t,o){if(!_){_=!0;var n;n=o?v(O,o.x,o.y):g(O,q,.5*F,.5*L);var e,i,a=w(no,n),r=a.x,s=a.y,l=0,h=0,d=0,p=0,f=no+t;90==f||-270==f?(l=r+s,h=s-r,f>no?(d=X-r-s,p=r-s):no>f&&(d=X-s-(U-r),p=r+s-X),e=X,i=U):180==f||-180==f?(l=2*r,h=2*s,f>no?(d=U-r-(X-s),p=X-(r+s)):no>f&&(d=U-(r+s),p=X-s-(U-r)),e=U,i=X):270==f||-90==f?(l=r-s,h=r+s,f>no?(d=r+s-U,p=U-r-(X-s)):no>f&&(d=s-r,p=U-r-s),e=X,i=U):(0==f||360==f||-360==f)&&(l=0,h=0,f>no?(d=r-s,p=r+s-U):no>f&&(d=r+s-X,p=s-r),e=U,i=X),0==no?(to=0,oo=0):90==no||-270==no?(to-=r+s,oo-=s-r):180==no||-180==no?(to-=2*r,oo-=2*s):(270==no||-90==no)&&(to-=r-s,oo-=r+s),to=to.toFixed(2)-0,oo=oo.toFixed(2)-0,T(Q,to,oo,no,r,s),M(Q,to,oo,f,200,function(){_=!1,no=f%360,to+=l+d,oo+=h+p,to=to.toFixed(2)-0,oo=oo.toFixed(2)-0,T(Q,to,oo,no),J.scrollTo(J.x-d*J.scale,J.y-p*J.scale),y(e,i),J.scale<J.options.zoomMin&&J.zoom(J.options.zoomMin),c(e,i)})}}function f(){G=document.createElement("canvas"),G.width=F,G.height=L}function u(){if(!Y)return void alert("亲，当前没有图片可以裁剪!");var t=g(O,q),o=J.scale,n=G.getContext("2d");n.clearRect(0,0,G.width,G.height),n.save(),H?n.scale(o,o):(G.width=F/o,G.height=L/o),n.translate(to-t.x/o,oo-t.y/o),n.rotate(no*Math.PI/180),n.drawImage(D[0],0,0),n.restore();var e=G.toDataURL("image/jpeg");B.css("background-image","url("+e+")"),P.call(D[0],e)}function m(){b(Z,function(){K=Z.width(),N=Z.height()})}function g(t,o,n,e){n=n||0,e=e||0;var i,a;return b(t,function(){i=t.offset()}),b(o,function(){a=o.offset()}),{x:a.left-i.left+n,y:a.top-i.top+e}}function v(t,o,n){o=o||0,n=n||0;var e;return b(t,function(){e=t.offset()}),{x:o+$.scrollLeft()-e.left,y:n+$.scrollTop()-e.top}}function b(o,n){var e=t();t.each(o,function(o,n){for(var i,a=t(n),r=a.parents().andSelf().filter(":hidden"),o=0;o<r.length&&a.is(":hidden");o++)i=r.eq(o),"none"==i.css("display")&&(e=e.add(i.show()))}),"function"==typeof n&&n.call(this),e.hide()}function w(t,o){var n=J.scale,e={};return 0==t?(e.x=o.x/n,e.y=o.y/n):90==t||-270==t?(e.x=o.y/n,e.y=X-o.x/n):180==t||-180==t?(e.x=U-o.x/n,e.y=X-o.y/n):(270==t||-90==t)&&(e.x=U-o.y/n,e.y=o.x/n),e}function x(t,o,n,e){var i=t/n,a=o/e;return i>a?i:a}function y(t,o){J.options.zoomMin=x(F,L,t,o),J.options.zoomMax=Math.max(1,J.options.zoomMin),J.options.zoomStart=Math.min(J.options.zoomMax,x(K,N,t,o))}function k(t,o,n,e){o=o||.8,n=n||0;var i="image/jpeg";void 0!=e&&"png"==e&&(i="image/png");var a=t.naturalWidth,r=t.naturalHeight,s=Math.max(a,r);if(s>1024){var c=Math.min(a,r);c=c/s*1024,s=1024,a>r?(a=s,r=c):(a=c,r=s)}var l=document.createElement("canvas"),h=l.getContext("2d");n?(l.width=r,l.height=a,h.translate(r,0),h.rotate(n*Math.PI/180)):(l.width=a,l.height=r),h.drawImage(t,0,0,a,r);var d=l.toDataURL(i,o||.8);return d}function z(o){D&&D.length&&(D.remove(),delete D[0]),D=t("<img>").css({"user-select":"none","pointer-events":"none"}),D.load(a),D.attr("src",o)}function T(t,o,n,i,a,r){a=a||0,r=r||0;var s={};s[e+"transform"]="translateZ(0) translate("+o+"px,"+n+"px) rotate("+i+"deg)",s[e+"transform-origin"]=a+"px "+r+"px",t.css(s)}function M(t,o,i,a,r,s){t.css(e+"transform"),t.css(e+"transition",e+"transform "+r+"ms"),t.one(n,function(){t.css(e+"transition",""),s.call(this)}),t.css(e+"transform","translateZ(0) translate("+o+"px,"+i+"px) rotate("+a+"deg)")}function S(){Z=t(o).css({"user-select":"none",overflow:"hidden"}),"static"==Z.css("position")&&Z.css("position","relative"),q=t("<div class='photo-clip-view'>").css({position:"absolute",left:"50%",top:"50%",width:F,height:L,"margin-left":-F/2,"margin-top":-L/2}).appendTo(Z),O=t("<div class='photo-clip-moveLayer'>").appendTo(q),Q=t("<div class='photo-clip-rotateLayer'>").appendTo(O);{var n=t("<div class='photo-clip-mask'>").css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo(Z);t("<div class='photo-clip-mask-left'>").css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto",height:L,"margin-right":F/2,"margin-top":-L/2,"margin-bottom":-L/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(n),t("<div class='photo-clip-mask-right'>").css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","margin-left":F/2,"margin-top":-L/2,"margin-bottom":-L/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(n),t("<div class='photo-clip-mask-top'>").css({position:"absolute",left:0,right:0,top:0,bottom:"50%","margin-bottom":L/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(n),t("<div class='photo-clip-mask-bottom'>").css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"margin-top":L/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(n),t("<div class='photo-clip-area'>").css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%",width:F,height:L,"margin-left":-F/2-1,"margin-top":-L/2-1}).appendTo(n)}B=t(C),B.length&&B.css({"background-color":"#666","background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}var F=i.width,L=i.height,R=i.file,C=i.view,E=i.ok,H=i.strictSize,I=i.loadStart,W=i.loadComplete,A=i.loadError,P=i.clipFinish,j=t(R);if(j.length){var D,U,X,Y;j.attr("accept","image/*"),j.change(function(){if(this.files.length){if(!/image\/\w+/.test(this.files[0].type))return alert("图片格式不正确，请选择正确格式的图片文件！"),!1;var o=new FileReader;o.onprogress=function(t){console.log((t.loaded/t.total*100).toFixed()+"%")},o.onload=function(o){var n=o.total/1024;if(n>1024){var e=1024/n,i=t("<img>").hide();i.load(function(){var t=this.naturalWidth;i.appendTo(document.body);var o=this.naturalHeight;i.remove(),delete i[0],i=null;var n=0;t==o&&(n=90);var a=k(this,e,n);z(a)}),i.attr("src",this.result)}else z(this.result)},o.onerror=function(t){alert("图片加载失败"),A.call(this,t)},o.readAsDataURL(this.files[0]),I.call(o,this.files[0])}}),j.click(function(){this.value=""});var Z,q,O,Q,B,G,J,K,N;S(),r(),l(),f();var V=t(E);V.length&&V.click(function(){u()});var $=t(window);m(),$.resize(m);var _,to,oo,no}}t.fn.photoClip=function(n){if(!window.FileReader)return void alert("您的浏览器不支持 HTML5 的 FileReader API， 因此无法初始化图片裁剪插件，请更换最新的浏览器！");var e={width:200,height:200,file:"",view:"",ok:"",strictSize:!1,loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){}};return t.extend(e,n),this.each(function(){o(this,e)}),this};var n,e="";!function(){var t,o={Webkit:"webkit",Moz:"",O:"o"},i=document.documentElement,a=function(o){return t?t+o:o.toLowerCase()};for(var r in o)if(void 0!==i.style[r+"TransitionProperty"]){e="-"+r.toLowerCase()+"-",t=o[r];break}n=a("TransitionEnd")}()}(jQuery);