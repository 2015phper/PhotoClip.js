/* jQuery photoClip v1.5 | Relying on the plug-in [iscroll-zoom.js] [hammer.js] */
!function(t,o){"use strict";"function"==typeof define&&define.amd?define(["jquery"],o):"object"==typeof exports?module.exports=o(require("jquery")):o(t.jQuery)}(this,function(t){"use strict";function o(o,i){function a(){Y=!0,B.append(this),b.call(this,D,function(){U=this.naturalWidth,X=this.naturalHeight}),b(Q,function(){s()}),W.call(this,this.src)}function r(){var t={zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"};K=new IScroll(O[0],t)}function s(){oo=0,eo=0,no=0,B.css({width:U,height:X}),T(B,oo,eo,no),y(U,X),K.zoom(K.options.zoomStart),c(U,X);var t=.5*(F-U*K.options.zoomStart),o=.5*(j-X*K.options.zoomStart);K.scrollTo(t,o)}function c(t,o){Q.css({width:t,height:o}),O.append(Q),K.refresh()}function l(){var t=!!navigator.userAgent.match(/mobile/i);if(t){var o=new Hammer(Q[0]);o.add(new Hammer.Rotate);var e,n;o.on("rotatemove",function(t){to||(e=t.rotation,e>180?e-=360:-180>e&&(e+=360),n=e>0?1:0>e?-1:0)}),o.on("rotateend",function(t){to||Math.abs(e)>30&&(1==n?p(t.center):-1==n&&h(t.center))})}else Q.on("dblclick",function(t){p({x:t.clientX,y:t.clientY})})}function p(t){d(90,t)}function h(t){d(-90,t)}function d(t,o){if(!to){to=!0;var e;e=o?v(Q,o.x,o.y):g(Q,O,.5*F,.5*j);var n,i,a=x(no,e),r=a.x,s=a.y,l=0,p=0,h=0,d=0,u=no+t;90==u||-270==u?(l=r+s,p=s-r,u>no?(h=X-r-s,d=r-s):no>u&&(h=X-s-(U-r),d=r+s-X),n=X,i=U):180==u||-180==u?(l=2*r,p=2*s,u>no?(h=U-r-(X-s),d=X-(r+s)):no>u&&(h=U-(r+s),d=X-s-(U-r)),n=U,i=X):270==u||-90==u?(l=r-s,p=r+s,u>no?(h=r+s-U,d=U-r-(X-s)):no>u&&(h=s-r,d=U-r-s),n=X,i=U):(0==u||360==u||-360==u)&&(l=0,p=0,u>no?(h=r-s,d=r+s-U):no>u&&(h=r+s-X,d=s-r),n=U,i=X),0==no?(oo=0,eo=0):90==no||-270==no?(oo-=r+s,eo-=s-r):180==no||-180==no?(oo-=2*r,eo-=2*s):(270==no||-90==no)&&(oo-=r-s,eo-=r+s),oo=oo.toFixed(2)-0,eo=eo.toFixed(2)-0,T(B,oo,eo,no,r,s),M(B,oo,eo,u,200,function(){to=!1,no=u%360,oo+=l+h,eo+=p+d,oo=oo.toFixed(2)-0,eo=eo.toFixed(2)-0,T(B,oo,eo,no),K.scrollTo(K.x-h*K.scale,K.y-d*K.scale),y(n,i),K.scale<K.options.zoomMin&&K.zoom(K.options.zoomMin),c(n,i)})}}function u(){J=document.createElement("canvas"),J.width=F,J.height=j}function f(){if(!Y)return void alert("亲，当前没有图片可以裁剪!");var t=g(Q,O),o=K.scale,e=J.getContext("2d");e.clearRect(0,0,J.width,J.height),e.save(),H?e.scale(o,o):(J.width=F/o,J.height=j/o),e.translate(oo-t.x/o,eo-t.y/o),e.rotate(no*Math.PI/180),e.drawImage(D[0],0,0),e.restore();var n=J.toDataURL(E,1);G.css("background-image","url("+n+")"),A.call(D[0],n)}function m(){b(Z,function(){N=Z.width(),V=Z.height()})}function g(t,o,e,n){e=e||0,n=n||0;var i,a;return b(t,function(){i=t.offset()}),b(o,function(){a=o.offset()}),{x:a.left-i.left+e,y:a.top-i.top+n}}function v(t,o,e){o=o||0,e=e||0;var n;return b(t,function(){n=t.offset()}),{x:o+_.scrollLeft()-n.left,y:e+_.scrollTop()-n.top}}function b(o,e){var n=t();t.each(o,function(o,e){for(var i,a=t(e),r=a.parents().andSelf().filter(":hidden"),o=0;o<r.length&&a.is(":hidden");o++)i=r.eq(o),"none"==i.css("display")&&(n=n.add(i.show()))}),"function"==typeof e&&e.call(this),n.hide()}function x(t,o){var e=K.scale,n={};return 0==t?(n.x=o.x/e,n.y=o.y/e):90==t||-270==t?(n.x=o.y/e,n.y=X-o.x/e):180==t||-180==t?(n.x=U-o.x/e,n.y=X-o.y/e):(270==t||-90==t)&&(n.x=U-o.y/e,n.y=o.x/e),n}function w(t,o,e,n){var i=t/e,a=o/n;return i>a?i:a}function y(t,o){K.options.zoomMin=w(F,j,t,o),K.options.zoomMax=Math.max(1,K.options.zoomMin),K.options.zoomStart=Math.min(K.options.zoomMax,w(N,V,t,o))}function k(t,o,e,n){o=o||.8,e=e||0;var i=n||"image/jpeg",a=t.naturalWidth,r=t.naturalHeight,s=Math.max(a,r);if(s>1024){var c=Math.min(a,r);c=c/s*1024,s=1024,a>r?(a=s,r=c):(a=c,r=s)}var l=document.createElement("canvas"),p=l.getContext("2d");e?(l.width=r,l.height=a,p.translate(r,0),p.rotate(e*Math.PI/180)):(l.width=a,l.height=r),p.drawImage(t,0,0,a,r);var h=l.toDataURL(i,o||.8);return h}function z(o){D&&D.length&&(D.remove(),delete D[0]),D=t("<img>").css({"user-select":"none","pointer-events":"none"}),D.load(a),D.attr("src",o)}function T(t,o,e,i,a,r){a=a||0,r=r||0;var s={};s[n+"transform"]="translateZ(0) translate("+o+"px,"+e+"px) rotate("+i+"deg)",s[n+"transform-origin"]=a+"px "+r+"px",t.css(s)}function M(t,o,i,a,r,s){t.css(n+"transform"),t.css(n+"transition",n+"transform "+r+"ms"),t.one(e,function(){t.css(n+"transition",""),s.call(this)}),t.css(n+"transform","translateZ(0) translate("+o+"px,"+i+"px) rotate("+a+"deg)")}function S(){Z=t(o).css({"user-select":"none",overflow:"hidden"}),"static"==Z.css("position")&&Z.css("position","relative"),O=t("<div class='photo-clip-view'>").css({position:"absolute",left:"50%",top:"50%",width:F,height:j,"margin-left":-F/2,"margin-top":-j/2}).appendTo(Z),Q=t("<div class='photo-clip-moveLayer'>").appendTo(O),B=t("<div class='photo-clip-rotateLayer'>").appendTo(Q);{var e=t("<div class='photo-clip-mask'>").css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo(Z);t("<div class='photo-clip-mask-left'>").css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto",height:j,"margin-right":F/2,"margin-top":-j/2,"margin-bottom":-j/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(e),t("<div class='photo-clip-mask-right'>").css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","margin-left":F/2,"margin-top":-j/2,"margin-bottom":-j/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(e),t("<div class='photo-clip-mask-top'>").css({position:"absolute",left:0,right:0,top:0,bottom:"50%","margin-bottom":j/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(e),t("<div class='photo-clip-mask-bottom'>").css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"margin-top":j/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(e),t("<div class='photo-clip-area'>").css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%",width:F,height:j,"margin-left":-F/2-1,"margin-top":-j/2-1}).appendTo(e)}G=t(R),G.length&&G.css({"background-color":"#666","background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}var F=i.width,j=i.height,L=i.file,R=i.view,C=i.ok,E=i.outputType||"image/jpeg",H=i.strictSize,I=i.loadStart,W=i.loadComplete,q=i.loadError,A=i.clipFinish;"jpg"===E?E="image/jpeg":"png"===E&&(E="image/png");var P=t(L);if(P.length){var D,U,X,Y;P.attr("accept","image/*"),P.change(function(){if(this.files.length){if(!/image\/\w+/.test(this.files[0].type))return alert("图片格式不正确，请选择正确格式的图片文件！"),!1;var o=new FileReader;o.onprogress=function(t){console.log((t.loaded/t.total*100).toFixed()+"%")},o.onload=function(o){var e=o.total/1024;if(e>1024){var n=1024/e,i=t("<img>").hide();i.load(function(){var t=this.naturalWidth;i.appendTo(document.body);var o=this.naturalHeight;i.remove(),delete i[0],i=null;var e=0;t==o&&(e=90);var a=k(this,n,e,E);z(a)}),i.attr("src",this.result)}else z(this.result)},o.onerror=function(t){alert("图片加载失败"),q.call(this,t)},o.readAsDataURL(this.files[0]),I.call(o,this.files[0])}}),P.click(function(){this.value=""});var Z,O,Q,B,G,J,K,N,V;S(),r(),l(),u();var $=t(C);$.length&&$.click(function(){f()});var _=t(window);m(),_.resize(m);var to,oo,eo,no}}t.fn.photoClip=function(e){if(!window.FileReader)return void alert("您的浏览器不支持 HTML5 的 FileReader API， 因此无法初始化图片裁剪插件，请更换最新的浏览器！");var n={width:200,height:200,file:"",view:"",ok:"",outputType:"jpg",strictSize:!1,loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){}};return t.extend(n,e),this.each(function(){o(this,n)}),this};var e,n="";!function(){var t,o={Webkit:"webkit",Moz:"",O:"o"},i=document.documentElement,a=function(o){return t?t+o:o.toLowerCase()};for(var r in o)if(void 0!==i.style[r+"TransitionProperty"]){n="-"+r.toLowerCase()+"-",t=o[r];break}e=a("TransitionEnd")}()});