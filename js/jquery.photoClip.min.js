!function(){function t(t,o){function i(){W=!0,j.append(this),m.call(this,C,function(){A=this.naturalWidth,E=this.naturalHeight}),m(U,function(){n()}),R.call(this,this.src)}function e(){var t={zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"};q=new IScroll(P[0],t)}function n(){K=0,N=0,O=0,j.css({width:A,height:E,"transform-origin":"0 0",transform:"translateZ(0px)",x:K,y:N,rotate:O}),x(A,E),q.zoom(q.options.zoomStart),a(A,E);var t=.5*(k-A*q.options.zoomStart),o=.5*(z-E*q.options.zoomStart);q.scrollTo(t,o)}function a(t,o){U.css({width:t,height:o}),P.append(U),q.refresh()}function r(){var t=!!navigator.userAgent.match(/mobile/i);if(t){var o=new Hammer(U[0]);o.add(new Hammer.Rotate);var i,e;o.on("rotatemove",function(t){J||(i=t.rotation,i>180?i-=360:-180>i&&(i+=360),e=i>0?1:0>i?-1:0)}),o.on("rotateend",function(t){J||Math.abs(i)>30&&(1==e?s(t.center):-1==e&&c(t.center))})}else U.on("dblclick",function(t){s({x:t.clientX,y:t.clientY})})}function s(t){l(90,t)}function c(t){l(-90,t)}function l(t,o){if(!J){J=!0;var i;i=o?u(U,o.x,o.y):f(U,P,.5*k,.5*z);var e,n,r=g(O,i),s=r.x,c=r.y,l=0,h=0,d=0,p=0,m=O+t;90==m||-270==m?(l=s+c,h=c-s,m>O?(d=E-s-c,p=s-c):O>m&&(d=E-c-(A-s),p=s+c-E),e=E,n=A):180==m||-180==m?(l=2*s,h=2*c,m>O?(d=A-s-(E-c),p=E-(s+c)):O>m&&(d=A-(s+c),p=E-c-(A-s)),e=A,n=E):270==m||-90==m?(l=s-c,h=s+c,m>O?(d=s+c-A,p=A-s-(E-c)):O>m&&(d=c-s,p=A-s-c),e=E,n=A):(0==m||360==m||-360==m)&&(l=0,h=0,m>O?(d=s-c,p=s+c-A):O>m&&(d=s+c-E,p=c-s),e=A,n=E),0==O?(K=0,N=0):90==O||-270==O?(K-=s+c,N-=c-s):180==O||-180==O?(K-=2*s,N-=2*c):(270==O||-90==O)&&(K-=s-c,N-=s+c),K=K.toFixed(2)-0,N=N.toFixed(2)-0,j.css({"transform-origin":s+"px "+c+"px",x:K,y:N}),j.transition({rotate:m},200,function(){J=!1,O=m%360,K+=l+d,N+=h+p,K=K.toFixed(2)-0,N=N.toFixed(2)-0,j.css({"transform-origin":"0 0",x:K,y:N,rotate:O}),q.scrollTo(q.x-d*q.scale,q.y-p*q.scale),x(e,n),q.scale<q.options.zoomMin&&q.zoom(q.options.zoomMin),a(e,n)})}}function h(){Y=document.createElement("canvas"),Y.width=k,Y.height=z}function d(){if(!W)return void alert("亲，当前没有图片可以裁剪!");var t=f(U,P),o=q.scale,i=Y.getContext("2d");i.clearRect(0,0,Y.width,Y.height),i.save(),i.scale(o,o),i.translate(K-t.x/o,N-t.y/o),i.rotate(O*Math.PI/180),i.drawImage(C[0],0,0),i.restore();var e=Y.toDataURL("image/jpeg");X.css("background-image","url("+e+")"),H.call(C[0],e)}function p(){m(D,function(){Z=D.width(),B=D.height()})}function f(t,o,i,e){i=i||0,e=e||0;var n,a;return m(t,function(){n=t.offset()}),m(o,function(){a=o.offset()}),{x:a.left-n.left+i,y:a.top-n.top+e}}function u(t,o,i){o=o||0,i=i||0;var e;return m(t,function(){e=t.offset()}),{x:o+G.scrollLeft()-e.left,y:i+G.scrollTop()-e.top}}function m(t,o){var i=$();$.each(t,function(t,o){for(var e,n=$(o),a=n.parents().andSelf().filter(":hidden"),t=0;t<a.length&&n.is(":hidden");t++)e=a.eq(t),"none"==e.css("display")&&(i=i.add(e.show()))}),"function"==typeof o&&o.call(this),i.hide()}function g(t,o){var i=q.scale,e={};return 0==t?(e.x=o.x/i,e.y=o.y/i):90==t||-270==t?(e.x=o.y/i,e.y=E-o.x/i):180==t||-180==t?(e.x=A-o.x/i,e.y=E-o.y/i):(270==t||-90==t)&&(e.x=A-o.y/i,e.y=o.x/i),e}function v(t,o,i,e){var n=t/i,a=o/e;return n>a?n:a}function x(t,o){q.options.zoomMin=v(k,z,t,o),q.options.zoomMax=Math.max(1,q.options.zoomMin),q.options.zoomStart=Math.min(q.options.zoomMax,v(Z,B,t,o))}function b(t,o,i,e){o=o||.8,i=i||0;var n="image/jpeg";void 0!=e&&"png"==e&&(n="image/png");var a=t.naturalWidth,r=t.naturalHeight,s=Math.max(a,r);s>1024&&(minSide=Math.min(a,r),minSide=minSide/s*1024,s=1024,a>r?(a=s,r=minSide):(a=minSide,r=s));var c=document.createElement("canvas"),l=c.getContext("2d");90==i?(c.width=r,c.height=a,l.translate(r,0),l.rotate(.5*Math.PI)):(c.width=a,c.height=r),l.drawImage(t,0,0,a,r);var h=c.toDataURL(n,o||.8);return h}function w(t){C&&C.length&&(C.remove(),delete C[0]),C=$("<img>").css({"user-select":"none","pointer-events":"none"}),C.load(i),C.attr("src",t)}function y(){D=$(t).css({"user-select":"none",overflow:"hidden"}),"static"==D.css("position")&&D.css("position","relative"),P=$("<div class='photo-clip-view'>").css({position:"absolute",left:"50%",top:"50%",width:k,height:z,"margin-left":-k/2,"margin-top":-z/2}).appendTo(D),U=$("<div class='photo-clip-moveLayer'>").appendTo(P),j=$("<div class='photo-clip-rotateLayer'>").appendTo(U);{var o=$("<div class='photo-clip-mask'>").css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo(D);$("<div class='photo-clip-mask-left'>").css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto",height:z,"margin-right":k/2,"margin-top":-z/2,"margin-bottom":-z/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),$("<div class='photo-clip-mask-right'>").css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","margin-left":k/2,"margin-top":-z/2,"margin-bottom":-z/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),$("<div class='photo-clip-mask-top'>").css({position:"absolute",left:0,right:0,top:0,bottom:"50%","margin-bottom":z/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),$("<div class='photo-clip-mask-bottom'>").css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"margin-top":z/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),$("<div class='photo-clip-area'>").css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%",width:k,height:z,"margin-left":-k/2-1,"margin-top":-z/2-1}).appendTo(o)}X=$(S),X.length&&X.css({"background-color":"#666","background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}var k=o.width,z=o.height,M=o.file,S=o.view,T=o.ok,F=o.loadStart,R=o.loadComplete,L=o.loadError,H=o.clipFinish,I=$(M);if(I.length){var C,A,E,W;I.attr("accept","image/*"),I.change(function(){if(this.files.length){if(!/image\/\w+/.test(this.files[0].type))return alert("图片格式不正确，请选择正确格式的图片文件！"),!1;var t=new FileReader;t.onprogress=function(t){console.log((t.loaded/t.total*100).toFixed()+"%")},t.onload=function(t){var o=t.total/1024;if(o>1024){var i=1024/o,e=$("<img>").hide();e.load(function(){var t=this.naturalWidth;e.appendTo(document.body);var o=this.naturalHeight;e.remove(),delete e[0],e=null;var n=0;t==o&&(n=90);var a=b(this,i,n);w(a)}),e.attr("src",this.result)}else w(this.result)},t.onerror=function(t){alert("图片加载失败"),L.call(this,t)},t.readAsDataURL(this.files[0]),F.call(t,this.files[0])}}),I.click(function(){this.value=""});var D,P,U,j,X,Y,q,Z,B;y(),e(),r(),h(),$ok=$(T),$ok.length&&$ok.click(function(){d()});var G=$(window);p(),G.resize(p);var J,K,N,O}}$.fn.photoClip=function(o){if(!window.FileReader)return void alert("您的浏览器不支持 HTML5 的 FileReader API， 因此无法初始化图片裁剪插件，请更换最新的浏览器！");var i={width:100,height:100,file:"",view:"",ok:"",loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){}};return $.extend(i,o),this.each(function(){t(this,i)}),this}}();