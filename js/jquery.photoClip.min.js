/* jQuery photoClip v1.10.0 | Relying on the plug-in [iscroll-zoom.js] [hammer.js] [lrz.all.bundle.js] */
!function(t,o){"use strict";"function"==typeof define&&define.amd?define(["jquery","iscroll-zoom","hammer","lrz"],o):"object"==typeof exports?module.exports=o(require("jquery"),require("iscroll-zoom"),require("hammer"),require("lrz")):(t.bjj=t.bjj||{},t.bjj.PhotoClip=o(t.jQuery,t.IScroll,t.Hammer,t.lrz))}(this,function(t,o,e,n){"use strict";function i(o,e){if(!window.FileReader)return void alert("您的浏览器不支持 HTML5 的 FileReader API， 因此无法初始化图片裁剪插件，请更换最新的浏览器！");var n=t.extend({},s,e),i=r(o,n);this.destroy=i.destroy}function r(i,r){function s(){$=!0,eo.append(this),w.call(this,K,function(){N=this.naturalWidth,V=this.naturalHeight}),w(oo,function(){u()}),U.call(this,this.src)}function l(){var t={zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"};ao=new o(to[0],t)}function u(){fo=0,ho=0,mo=0,eo.css({width:N,height:V}),S(eo,fo,ho,mo),T(N,V),ao.zoom(ao.options.zoomStart),p(N,V);var t=.5*(Z-N*ao.options.zoomStart),o=.5*(B-V*ao.options.zoomStart);ao.scrollTo(t,o)}function p(t,o){oo.css({width:t,height:o}),to.append(oo),ao.refresh()}function f(){var t=!!navigator.userAgent.match(/mobile/i);if(t){ro=new e(oo[0]),ro.add(new e.Rotate);var o,n;ro.on("rotatemove",function(t){po||(o=t.rotation,o>180?o-=360:-180>o&&(o+=360),n=o>0?1:0>o?-1:0)}),ro.on("rotateend",function(t){po||Math.abs(o)>30&&(1==n?d(t.center):-1==n&&h(t.center))})}else oo.on("dblclick",function(t){d({x:t.clientX,y:t.clientY})})}function d(t){m(90,t)}function h(t){m(-90,t)}function m(t,o){if(!po){po=!0;var e;e=o?x(oo,o.x,o.y):y(oo,to,.5*Z,.5*B);var n,i,r=z(mo,e),a=r.x,s=r.y,c=0,l=0,u=0,f=0,d=mo+t;90==d||-270==d?(c=a+s,l=s-a,d>mo?(u=V-a-s,f=a-s):mo>d&&(u=V-s-(N-a),f=a+s-V),n=V,i=N):180==d||-180==d?(c=2*a,l=2*s,d>mo?(u=N-a-(V-s),f=V-(a+s)):mo>d&&(u=N-(a+s),f=V-s-(N-a)),n=N,i=V):270==d||-90==d?(c=a-s,l=a+s,d>mo?(u=a+s-N,f=N-a-(V-s)):mo>d&&(u=s-a,f=N-a-s),n=V,i=N):(0==d||360==d||-360==d)&&(c=0,l=0,d>mo?(u=a-s,f=a+s-N):mo>d&&(u=a+s-V,f=s-a),n=N,i=V),0==mo?(fo=0,ho=0):90==mo||-270==mo?(fo-=a+s,ho-=s-a):180==mo||-180==mo?(fo-=2*a,ho-=2*s):(270==mo||-90==mo)&&(fo-=a-s,ho-=a+s),fo=fo.toFixed(2)-0,ho=ho.toFixed(2)-0,S(eo,fo,ho,mo,a,s),F(eo,fo,ho,d,200,function(){po=!1,mo=d%360,fo+=c+u,ho+=l+f,fo=fo.toFixed(2)-0,ho=ho.toFixed(2)-0,S(eo,fo,ho,mo),ao.scrollTo(ao.x-u*ao.scale,ao.y-f*ao.scale),T(n,i),ao.scale<ao.options.zoomMin&&ao.zoom(ao.options.zoomMin),p(n,i)})}}function g(){io=document.createElement("canvas")}function v(){if(!$)return void alert("亲，当前没有图片可以裁剪!");var t=y(oo,to),o=ao.scale,e=io.getContext("2d");e.clearRect(0,0,io.width,io.height),e.save(),Q&&G?(io.width=Q,io.height=G,e.scale(Q/Z*o,G/B*o)):(io.width=Z/o,io.height=B/o),e.translate(fo-t.x/o,ho-t.y/o),e.rotate(mo*Math.PI/180),e.drawImage(K[0],0,0),e.restore();try{var n=io.toDataURL(I,1)}catch(i){throw new Error("截图失败！当前图片源文件可能存在跨域问题，请确保图片与应用同源。如果您是在本地环境下执行本程序，请更换至服务器环境。")}no.css("background-image","url("+n+")"),Y.call(K[0],n)}function b(){w(_,function(){so=_.width(),co=_.height()})}function y(t,o,e,n){e=e||0,n=n||0;var i,r;return w(t,function(){i=t.offset()}),w(o,function(){r=o.offset()}),{x:r.left-i.left+e,y:r.top-i.top+n}}function x(t,o,e){o=o||0,e=e||0;var n;return w(t,function(){n=t.offset()}),{x:o+uo.scrollLeft()-n.left,y:e+uo.scrollTop()-n.top}}function w(o,e){var n=t();t.each(o,function(o,e){for(var i,r=t(e),a=r.parents().addBack().filter(":hidden"),o=0;o<a.length&&r.is(":hidden");o++)i=a.eq(o),"none"==i.css("display")&&(n=n.add(i.show()))}),"function"==typeof e&&e.call(this),n.hide()}function z(t,o){var e=ao.scale,n={};return 0==t?(n.x=o.x/e,n.y=o.y/e):90==t||-270==t?(n.x=o.y/e,n.y=V-o.x/e):180==t||-180==t?(n.x=N-o.x/e,n.y=V-o.y/e):(270==t||-90==t)&&(n.x=N-o.y/e,n.y=o.x/e),n}function k(t,o,e,n){var i=t/e,r=o/n;return i>r?i:r}function T(t,o){ao.options.zoomMin=k(Z,B,t,o),ao.options.zoomMax=Math.max(1,ao.options.zoomMin),ao.options.zoomStart=Math.min(ao.options.zoomMax,k(so,co,t,o))}function j(){K&&K.length&&(K.remove(),delete K[0])}function M(o){j(),K=t("<img>").css({"user-select":"none","pointer-events":"none"}),K.on("load",s),K.attr("src",o)}function S(t,o,e,n,i,r){i=i||0,r=r||0;var a={};a[c+"transform"]="translateZ(0) translate("+o+"px,"+e+"px) rotate("+n+"deg)",a[c+"transform-origin"]=i+"px "+r+"px",t.css(a)}function F(t,o,e,n,i,r){t.css(c+"transform"),t.css(c+"transition",c+"transform "+i+"ms"),t.one(a,function(){t.css(c+"transition",""),r.call(this)}),t.css(c+"transform","translateZ(0) translate("+o+"px,"+e+"px) rotate("+n+"deg)")}function L(t){return"[object Array]"===Object.prototype.toString.call(t)}function q(){_=t(i).css({"user-select":"none",overflow:"hidden"}),"static"==_.css("position")&&_.css("position","relative"),to=t("<div class='photo-clip-view'>").css({position:"absolute",left:"50%",top:"50%",width:Z,height:B,"margin-left":-Z/2,"margin-top":-B/2}).appendTo(_),oo=t("<div class='photo-clip-moveLayer'>").appendTo(to),eo=t("<div class='photo-clip-rotateLayer'>").appendTo(oo);{var o=t("<div class='photo-clip-mask'>").css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo(_);t("<div class='photo-clip-mask-left'>").css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto",height:B,"margin-right":Z/2,"margin-top":-B/2,"margin-bottom":-B/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),t("<div class='photo-clip-mask-right'>").css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","margin-left":Z/2,"margin-top":-B/2,"margin-bottom":-B/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),t("<div class='photo-clip-mask-top'>").css({position:"absolute",left:0,right:0,top:0,bottom:"50%","margin-bottom":B/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),t("<div class='photo-clip-mask-bottom'>").css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"margin-top":B/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),t("<div class='photo-clip-area'>").css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%",width:Z,height:B,"margin-left":-Z/2-1,"margin-top":-B/2-1}).appendTo(o)}no=t(H),no.length&&no.css({"background-color":"#666","background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}function R(){J.off("change"),J=null,ro?(ro.off("rotatemove"),ro.off("rotateend"),ro.destroy(),ro=null):oo.off("dblclick"),ao.destroy(),ao=null,_.empty(),_=null,to=null,oo=null,eo=null,no.css({"background-color":"","background-repeat":"","background-position":"","background-size":""}),no=null}var C=r.size,E=r.outputSize,A=r.lrzOption,I=r.outputType||"image/jpeg",O=r.file,P=r.source,H=r.view,W=r.ok,D=r.loadStart,U=r.loadComplete,X=r.loadError,Y=r.clipFinish;L(C)||(C=[260,260]),L(E)||(E=[0,0]);var Z=C[0]||260,B=C[1]||260,Q=Math.max(E[0],0),G=Math.max(E[1],0);"jpg"===I?I="image/jpeg":"png"===I&&(I="image/png");var J=t(O);J.length&&(J.attr("accept","image/*"),J.on("change",function(){if(this.files.length){var t=this.files[0];if(!/image\/\w+/.test(t.type))return alert("图片格式不正确，请选择正确格式的图片文件！"),!1;var o=new FileReader;o.onprogress=function(t){console.log((t.loaded/t.total*100).toFixed()+"%")},o.onload=function(){n(t,A).then(function(t){M(t.base64)}).catch(function(t){alert("图片处理失败"),X.call(this,t)})},o.onerror=function(t){alert("图片加载失败"),X.call(this,t)},o.readAsDataURL(t),D.call(o,t)}}),J.click(function(){this.value=""})),P&&M(P);var K,N,V,$,_,to,oo,eo,no,io,ro,ao,so,co;q(),l(),f(),g();var lo=t(W);lo.length&&lo.click(function(){v()});var uo=t(window);b(),uo.resize(b);var po,fo,ho,mo;return{destroy:R}}var a,s={size:[260,260],outputSize:[0,0],outputType:"jpg",file:"",source:"",view:"",ok:"",loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){},lrzOption:{}},c="";return function(){var t,o={Webkit:"webkit",Moz:"",O:"o"},e=document.documentElement,n=function(o){return t?t+o:o.toLowerCase()};for(var i in o)if(void 0!==e.style[i+"TransitionProperty"]){c="-"+i.toLowerCase()+"-",t=o[i];break}a=n("TransitionEnd")}(),i});