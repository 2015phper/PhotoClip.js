!function(){function t(t,o){function e(){E=!0,U.append(this),C=this.naturalWidth,A=this.naturalHeight,n(),F.call(this,this.src)}function i(){var t={zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"};j=new IScroll(D[0],t)}function n(){J=0,K=0,N=0,U.css({width:C,height:A,"transform-origin":"0 0",transform:"translateZ(0px)",x:J,y:K,rotate:N}),v(C,A),j.zoom(j.options.zoomStart),a(C,A);var t=.5*(y-C*j.options.zoomStart),o=.5*(k-A*j.options.zoomStart);j.scrollTo(t,o)}function a(t,o){P.css({width:t,height:o}),D.append(P),j.refresh()}function r(){var t=!!navigator.userAgent.match(/mobile/i);if(t){var o=new Hammer(P[0]);o.add(new Hammer.Rotate);var e,i;o.on("rotatemove",function(t){G||(e=t.rotation,e>180?e-=360:-180>e&&(e+=360),i=e>0?1:0>e?-1:0)}),o.on("rotateend",function(t){G||Math.abs(e)>30&&(1==i?s(t.center):-1==i&&l(t.center))})}else P.on("dblclick",function(t){s({x:t.clientX,y:t.clientY})})}function s(t){c(90,t)}function l(t){c(-90,t)}function c(t,o){if(!G){G=!0;var e;e=o?u(P,o.x,o.y):f(P,D,.5*y,.5*k);var i,n,r=m(N,e),s=r.x,l=r.y,c=0,h=0,d=0,p=0,g=N+t;90==g||-270==g?(c=s+l,h=l-s,g>N?(d=A-s-l,p=s-l):N>g&&(d=A-l-(C-s),p=s+l-A),i=A,n=C):180==g||-180==g?(c=2*s,h=2*l,g>N?(d=C-s-(A-l),p=A-(s+l)):N>g&&(d=C-(s+l),p=A-l-(C-s)),i=C,n=A):270==g||-90==g?(c=s-l,h=s+l,g>N?(d=s+l-C,p=C-s-(A-l)):N>g&&(d=l-s,p=C-s-l),i=A,n=C):(0==g||360==g||-360==g)&&(c=0,h=0,g>N?(d=s-l,p=s+l-C):N>g&&(d=s+l-A,p=l-s),i=C,n=A),0==N?(J=0,K=0):90==N||-270==N?(J-=s+l,K-=l-s):180==N||-180==N?(J-=2*s,K-=2*l):(270==N||-90==N)&&(J-=s-l,K-=s+l),J=J.toFixed(2)-0,K=K.toFixed(2)-0,U.css({"transform-origin":s+"px "+l+"px",x:J,y:K}),U.transition({rotate:g},200,function(){G=!1,N=g%360,J+=c+d,K+=h+p,J=J.toFixed(2)-0,K=K.toFixed(2)-0,U.css({"transform-origin":"0 0",x:J,y:K,rotate:N}),j.scrollTo(j.x-d*j.scale,j.y-p*j.scale),v(i,n),j.scale<j.options.zoomMin&&j.zoom(j.options.zoomMin),a(i,n)})}}function h(){Y=document.createElement("canvas"),Y.width=y,Y.height=k}function d(){if(!E)return void alert("亲，当前没有图片可以裁剪!");var t=f(P,D),o=j.scale,e=Y.getContext("2d");e.clearRect(0,0,Y.width,Y.height),e.save(),e.scale(o,o),e.translate(J-t.x/o,K-t.y/o),e.rotate(N*Math.PI/180),e.drawImage(I[0],0,0),e.restore();var i=Y.toDataURL();X.css("background-image","url("+i+")"),L(i)}function p(){Z=W.width(),q=W.height()}function f(t,o,e,i){e=e||0,i=i||0;var n=t.offset(),a=o.offset();return{x:a.left-n.left+e,y:a.top-n.top+i}}function u(t,o,e){o=o||0,e=e||0;var i=t.offset();return{x:o+B.scrollLeft()-i.left,y:e+B.scrollTop()-i.top}}function m(t,o){var e=j.scale,i={};return 0==t?(i.x=o.x/e,i.y=o.y/e):90==t||-270==t?(i.x=o.y/e,i.y=A-o.x/e):180==t||-180==t?(i.x=C-o.x/e,i.y=A-o.y/e):(270==t||-90==t)&&(i.x=C-o.y/e,i.y=o.x/e),i}function g(t,o,e,i){var n=t/e,a=o/i;return n>a?n:a}function v(t,o){j.options.zoomMin=g(y,k,t,o),j.options.zoomMax=Math.max(1,j.options.zoomMin),j.options.zoomStart=Math.min(j.options.zoomMax,g(Z,q,t,o))}function x(t,o,e,i){o=o||.8,e=e||0;var n="image/jpeg";void 0!=i&&"png"==i&&(n="image/png");var a=t.naturalWidth,r=t.naturalHeight,s=Math.max(a,r);s>1024&&(minSide=Math.min(a,r),minSide=minSide/s*1024,s=1024,a>r?(a=s,r=minSide):(a=minSide,r=s));var l=document.createElement("canvas"),c=l.getContext("2d");90==e?(l.width=r,l.height=a,c.translate(r,0),c.rotate(.5*Math.PI)):(l.width=a,l.height=r),c.drawImage(t,0,0,a,r);var h=l.toDataURL(n,o||.8);return h}function b(t){I&&I.length&&(I.remove(),delete I[0]),I=$("<img>").css({"user-select":"none","pointer-events":"none"}),I.load(e),I.attr("src",t)}function w(){W=$(t).css({"user-select":"none",overflow:"hidden"}),"static"==W.css("position")&&W.css("position","relative"),D=$("<div class='photo-clip-view'>").css({position:"absolute",left:"50%",top:"50%",width:y,height:k,"margin-left":-y/2,"margin-top":-k/2}).appendTo(W),P=$("<div class='photo-clip-moveLayer'>").appendTo(D),U=$("<div class='photo-clip-rotateLayer'>").appendTo(P);{var o=$("<div class='photo-clip-mask'>").css({position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}).appendTo(W);$("<div class='photo-clip-mask-left'>").css({position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto",height:k,"margin-right":y/2,"margin-top":-k/2,"margin-bottom":-k/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),$("<div class='photo-clip-mask-right'>").css({position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","margin-left":y/2,"margin-top":-k/2,"margin-bottom":-k/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),$("<div class='photo-clip-mask-top'>").css({position:"absolute",left:0,right:0,top:0,bottom:"50%","margin-bottom":k/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),$("<div class='photo-clip-mask-bottom'>").css({position:"absolute",left:0,right:0,top:"50%",bottom:0,"margin-top":k/2,"background-color":"rgba(0,0,0,.5)"}).appendTo(o),$("<div class='photo-clip-area'>").css({border:"1px dashed #ddd",position:"absolute",left:"50%",top:"50%",width:y,height:k,"margin-left":-y/2-1,"margin-top":-k/2-1}).appendTo(o)}X=$(M),X.length&&X.css({"background-color":"#666","background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}var y=o.width,k=o.height,z=o.file,M=o.view,T=o.ok,S=o.loadStart,F=o.loadComplete,R=o.loadError,L=o.clipFinish,H=$(z);if(H.length){var I,C,A,E;H.attr("accept","image/*"),H.change(function(){if(this.files.length){if(!/image\/\w+/.test(this.files[0].type))return alert("图片格式不正确，请选择正确格式的图片文件！"),!1;var t=new FileReader;t.onprogress=function(t){console.log((t.loaded/t.total*100).toFixed()+"%")},t.onload=function(t){var o=t.total/1024;if(o>1024){var e=1024/o,i=$("<img>").hide();i.load(function(){var t=this.naturalWidth;i.appendTo(document.body);var o=this.naturalHeight;i.remove(),delete i[0],i=null;var n=0;t==o&&(n=90);var a=x(this,e,n);b(a)}),i.attr("src",this.result)}else b(this.result)},t.onerror=function(t){alert("图片加载失败"),R.call(this,t)},t.readAsDataURL(this.files[0]),S.call(t,this.files[0])}});var W,D,P,U,X,Y,j,Z,q;w(),i(),r(),h(),$ok=$(T),$ok.length&&$ok.click(function(){d()});var B=$(window);p(),B.resize(p);var G,J,K,N}}$.fn.photoClip=function(o){if(!window.FileReader)return void alert("您的浏览器不支持 HTML5 的 FileReader API， 因此无法初始化图片裁剪插件，请更换最新的浏览器！");var e={width:100,height:100,file:"",view:"",ok:"",loadStart:function(){},loadComplete:function(){},loadError:function(){},clipFinish:function(){}};return $.extend(e,o),this.each(function(){t(this,e)}),this}}();